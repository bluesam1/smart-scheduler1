# Story 3.1: Availability Engine Domain Logic

## Status
Approved

## Story

**As a** system,
**I want** availability engine domain logic implemented,
**so that** I can calculate feasible time slots for contractors based on their schedules.

## Acceptance Criteria

1. **Availability Calculation:** Core algorithm to calculate available slots
2. **Working Hours Integration:** Uses contractor working hours
3. **Existing Jobs:** Considers existing assignments/jobs
4. **Slot Generation:** Generates feasible time slots for given time window
5. **Domain Service:** Availability engine as domain service
6. **Deterministic Results:** Same inputs produce same outputs
7. **Edge Case Handling:** Handles edge cases (overlaps, boundaries, timezone)
8. **Performance:** Efficient slot calculation
9. **Testability:** Logic easily testable with unit tests
10. **Documentation:** Algorithm documented

## Tasks / Subtasks

- [ ] Create availability engine service
  - [ ] Create `IAvailabilityEngine` interface in domain
  - [ ] Create `AvailabilityEngine` implementation
  - [ ] Define core calculation methods
- [ ] Implement working hours processing
  - [ ] Process weekly working hours
  - [ ] Handle timezone conversions
  - [ ] Handle day-of-week logic
- [ ] Implement existing jobs consideration
  - [ ] Load existing assignments for contractor
  - [ ] Block out assigned time slots
  - [ ] Handle overlapping assignments
- [ ] Implement slot generation
  - [ ] Generate slots within working hours
  - [ ] Exclude blocked time
  - [ ] Return feasible slots
- [ ] Add edge case handling
  - [ ] Handle timezone boundaries
  - [ ] Handle day boundaries
  - [ ] Handle no available slots
- [ ] Create unit tests
  - [ ] Test various scenarios
  - [ ] Test edge cases
  - [ ] Verify deterministic results

## Dev Notes

### Relevant Source Tree Info
- Availability engine: `src/SmartScheduler.Domain/Scheduling/Services/AvailabilityEngine.cs`
- Interface: `src/SmartScheduler.Domain/Scheduling/Services/IAvailabilityEngine.cs`

### Architecture References
- **Availability Engine:** See `docs/prd/epic-3-availability-engine-v1-hours-buffers.md`
- **Scheduling Module:** See `docs/architecture/high-level-architecture.md`
- **Travel Buffers:** See Epic 3.3 for buffer implementation

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Unit Tests:** Comprehensive unit tests for availability calculation
- **Property Tests:** Property-based tests for slot generation
- **Edge Cases:** Test overlaps, boundaries, timezone issues

### UI Integration Notes
- Availability engine used by recommendations API
- Results displayed in recommendation cards
- UI shows available time slots to dispatchers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

