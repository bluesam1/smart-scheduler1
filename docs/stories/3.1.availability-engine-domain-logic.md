# Story 3.1: Availability Engine Domain Logic

## Status
Ready for Review

## Story

**As a** system,
**I want** availability engine domain logic implemented,
**so that** I can calculate feasible time slots for contractors based on their schedules.

## Acceptance Criteria

1. **Availability Calculation:** Core algorithm to calculate available slots
2. **Working Hours Integration:** Uses contractor working hours
3. **Existing Jobs:** Considers existing assignments/jobs
4. **Slot Generation:** Generates feasible time slots for given time window
5. **Domain Service:** Availability engine as domain service
6. **Deterministic Results:** Same inputs produce same outputs
7. **Edge Case Handling:** Handles edge cases (overlaps, boundaries, timezone)
8. **Performance:** Efficient slot calculation
9. **Testability:** Logic easily testable with unit tests
10. **Documentation:** Algorithm documented

## Tasks / Subtasks

- [x] Create availability engine service
  - [x] Create `IAvailabilityEngine` interface in domain
  - [x] Create `AvailabilityEngine` implementation
  - [x] Define core calculation methods
- [x] Implement working hours processing
  - [x] Process weekly working hours
  - [x] Handle timezone conversions
  - [x] Handle day-of-week logic
- [x] Implement existing jobs consideration
  - [x] Load existing assignments for contractor
  - [x] Block out assigned time slots
  - [x] Handle overlapping assignments
- [x] Implement slot generation
  - [x] Generate slots within working hours
  - [x] Exclude blocked time
  - [x] Return feasible slots
- [x] Add edge case handling
  - [x] Handle timezone boundaries
  - [x] Handle day boundaries
  - [x] Handle no available slots
- [x] Create unit tests
  - [x] Test various scenarios
  - [x] Test edge cases
  - [x] Verify deterministic results

## Dev Notes

### Relevant Source Tree Info
- Availability engine: `src/SmartScheduler.Domain/Scheduling/Services/AvailabilityEngine.cs`
- Interface: `src/SmartScheduler.Domain/Scheduling/Services/IAvailabilityEngine.cs`

### Architecture References
- **Availability Engine:** See `docs/prd/epic-3-availability-engine-v1-hours-buffers.md`
- **Scheduling Module:** See `docs/architecture/high-level-architecture.md`
- **Travel Buffers:** See Epic 3.3 for buffer implementation

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Unit Tests:** Comprehensive unit tests for availability calculation
- **Property Tests:** Property-based tests for slot generation
- **Edge Cases:** Test overlaps, boundaries, timezone issues

### UI Integration Notes
- Availability engine used by recommendations API
- Results displayed in recommendation cards
- UI shows available time slots to dispatchers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `IAvailabilityEngine` interface and `AvailabilityEngine` implementation in `src/SmartScheduler.Domain/Scheduling/Services/`
- Implemented core availability calculation algorithm that:
  - Processes weekly working hours with timezone conversion support
  - Handles calendar exceptions (holidays and overrides)
  - Blocks out existing assignments
  - Generates feasible slots that fit job duration
  - Handles edge cases (day boundaries, timezone boundaries, no available slots)
- Added TimeZoneConverter NuGet package for IANA timezone support
- Created comprehensive unit tests covering:
  - Basic working hours scenarios
  - Existing assignment blocking
  - Holiday exclusion
  - Override exception handling
  - Window too short scenarios
  - Multi-day windows
  - Deterministic results verification
- All 8 unit tests pass successfully
- Algorithm is deterministic and handles all edge cases

### File List
- `src/SmartScheduler.Domain/Scheduling/Services/IAvailabilityEngine.cs` (new)
- `src/SmartScheduler.Domain/Scheduling/Services/AvailabilityEngine.cs` (new)
- `src/SmartScheduler.Domain.Tests/Scheduling/AvailabilityEngineTests.cs` (new)
- `src/SmartScheduler.Domain/SmartScheduler.Domain.csproj` (modified - added TimeZoneConverter package)

## QA Results
_To be populated by QA agent_

