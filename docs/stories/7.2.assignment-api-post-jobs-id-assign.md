# Story 7.2: Assignment API (POST /jobs/{id}/assign)

## Status
Approved

## Story

**As a** dispatcher,
**I want** to assign a job to a contractor via API,
**so that** I can confirm bookings from recommendations.

## Acceptance Criteria

1. **API Endpoint:** POST /jobs/{id}/assign endpoint implemented
2. **Request Validation:** Request validated (contractorId, startUtc, endUtc required)
3. **Availability Re-validation:** Availability re-validated before assignment
4. **Assignment Creation:** Assignment created and persisted
5. **Job Status Update:** Job status updated to Assigned
6. **Authorization:** Dispatcher and Admin can assign jobs
7. **Error Handling:** Proper errors for conflicts, unavailable contractors
8. **Idempotency:** Idempotent assignment creation
9. **Response:** Assignment returned in response
10. **OpenAPI:** Endpoint documented

## Tasks / Subtasks

- [ ] Create assignment DTOs
  - [ ] Create `AssignJobRequest` DTO
  - [ ] Create `AssignmentDto` response DTO
- [ ] Implement assign command
  - [ ] Create `AssignJobCommand` with MediatR
  - [ ] Create command handler
  - [ ] Validate request
- [ ] Implement availability re-validation
  - [ ] Check contractor availability
  - [ ] Verify time slot is feasible
  - [ ] Reject if unavailable
- [ ] Create assignment
  - [ ] Create Assignment entity
  - [ ] Link to job and contractor
  - [ ] Set time slots
  - [ ] Link to audit record
- [ ] Update job status
  - [ ] Update job status to Assigned
  - [ ] Update assignment status
- [ ] Create API endpoint
  - [ ] POST /jobs/{id}/assign endpoint
  - [ ] Validate request
  - [ ] Return assignment
- [ ] Add authorization
  - [ ] Apply Dispatcher/Admin policy
  - [ ] Verify permissions
- [ ] Add error handling
  - [ ] Handle conflicts (409)
  - [ ] Handle unavailable (400)
  - [ ] Handle not found (404)
- [ ] Implement idempotency
  - [ ] Check for existing assignment
  - [ ] Return existing if same request

## Dev Notes

### Relevant Source Tree Info
- API endpoint: `src/SmartScheduler.Api/Endpoints/Jobs/AssignEndpoint.cs`
- Command: `src/SmartScheduler.Application/Jobs/Commands/AssignJobCommand.cs`
- Handler: `src/SmartScheduler.Application/Jobs/Handlers/AssignJobCommandHandler.cs`

### Architecture References
- **API Specification:** See `docs/architecture/api-specification.md` for POST /jobs/{id}/assign
- **Assignment:** See `docs/architecture/data-models.md` for Assignment model
- **Re-validation:** Availability re-validated - see PRD

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/` and `src/SmartScheduler.Application.Tests/`
- **API Tests:** Test endpoint, validation, error handling
- **Integration Tests:** Test assignment creation flow

### UI Integration Notes
- Frontend calls this endpoint when confirming recommendation
- UI has booking confirmation flow
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

