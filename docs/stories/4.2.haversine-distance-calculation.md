# Story 4.2: Haversine Distance Calculation

## Status
Approved

## Story

**As a** system,
**I want** Haversine distance calculation for initial filtering,
**so that** I can quickly filter contractors by approximate distance before expensive API calls.

## Acceptance Criteria

1. **Haversine Implementation:** Haversine formula implemented
2. **Distance Calculation:** Calculate great-circle distance between two points
3. **Performance:** Fast calculation for bulk filtering
4. **Accuracy:** Sufficient accuracy for initial filtering
5. **Coarse Filtering:** Used for initial candidate filtering
6. **Integration:** Integrated with recommendations flow
7. **Unit Tests:** Comprehensive unit tests
8. **Documentation:** Haversine usage documented
9. **Fallback:** Can be used as fallback if ORS unavailable
10. **Optimization:** Optimized for performance

## Tasks / Subtasks

- [x] Implement Haversine formula
  - [x] Create `HaversineCalculator` class
  - [x] Implement distance calculation
  - [x] Return distance in meters
- [x] Add performance optimization
  - [x] Optimize calculation for speed
  - [x] Consider using approximate formulas if needed
- [ ] Integrate with recommendations
  - [ ] Use for initial contractor filtering
  - [ ] Filter by maximum distance threshold
  - [ ] Pass filtered candidates to ORS
  - Note: Integration deferred to recommendations flow (Story 6.1)
- [x] Create unit tests
  - [x] Test distance calculation accuracy
  - [x] Test edge cases (same point, antipodal points)
  - [x] Test performance
- [x] Add fallback support
  - [x] Use Haversine if ORS unavailable (implemented in DistanceCalculationService)
  - [x] Log fallback usage
- [x] Document usage
  - [x] Document when Haversine is used
  - [x] Document accuracy limitations

## Dev Notes

### Relevant Source Tree Info
- Haversine calculator: `src/SmartScheduler.Domain/Scheduling/Utilities/HaversineCalculator.cs`

### Architecture References
- **Coarse-to-Refine:** See `docs/prd/caching-performance.md`
- **Strategy:** Haversine for initial filtering, ORS for top candidates - see PRD
- **Performance:** Fast calculation for bulk filtering - see architecture

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Calculation Tests:** Test distance accuracy
- **Performance Tests:** Verify fast calculation

### UI Integration Notes
- Haversine not directly used in UI
- Results affect which contractors appear in recommendations
- Final distance shown uses ORS (more accurate)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `HaversineCalculator` static class in `src/SmartScheduler.Domain/Scheduling/Utilities/`
- Implemented Haversine formula for great-circle distance calculation
- Returns distance in meters using Earth's mean radius (6,371,000 meters)
- Optimized for performance with efficient mathematical operations
- Created comprehensive unit tests covering:
  - Same point (returns 0)
  - Real-world distances (NYC to LA, short distances)
  - Edge cases (antipodal points, equator crossing, prime meridian crossing)
  - Performance (1000 calculations in < 1 second)
- All 9 unit tests pass successfully
- Fallback support implemented in `DistanceCalculationService` (Story 4.5)
- Integration with recommendations flow deferred to Story 6.1

### File List
- `src/SmartScheduler.Domain/Scheduling/Utilities/HaversineCalculator.cs` (new)
- `src/SmartScheduler.Domain.Tests/Scheduling/HaversineCalculatorTests.cs` (new)

## QA Results
_To be populated by QA agent_

