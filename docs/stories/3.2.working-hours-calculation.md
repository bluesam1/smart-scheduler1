# Story 3.2: Working Hours Calculation

## Status
Approved

## Story

**As a** system,
**I want** to calculate available time based on contractor working hours,
**so that** I can determine when contractors are available for jobs.

## Acceptance Criteria

1. **Weekly Schedule:** Process weekly working hours schedule
2. **Day-of-Week Logic:** Handle different schedules per day
3. **Timezone Handling:** Convert working hours to appropriate timezone
4. **Exception Handling:** Process calendar exceptions (holidays, overrides)
5. **Break Time:** Account for daily break minutes
6. **Time Window Filtering:** Filter available time by requested service window
7. **Multi-Day Windows:** Handle service windows spanning multiple days
8. **Efficient Calculation:** Fast calculation for real-time use
9. **Edge Cases:** Handle edge cases (midnight boundaries, DST transitions)
10. **Validation:** Validate working hours are consistent

## Tasks / Subtasks

- [ ] Implement weekly schedule processing
  - [ ] Process WorkingHours array
  - [ ] Group by day of week
  - [ ] Handle multiple time windows per day
- [ ] Implement timezone conversion
  - [ ] Convert working hours to UTC or job timezone
  - [ ] Handle IANA timezone identifiers
  - [ ] Handle DST transitions
- [ ] Implement exception handling
  - [ ] Process calendar exceptions
  - [ ] Apply holiday blackouts
  - [ ] Apply custom overrides
- [ ] Implement break time logic
  - [ ] Account for daily break minutes
  - [ ] Apply breaks between jobs
  - [ ] Configurable break duration
- [ ] Implement time window filtering
  - [ ] Filter available time by service window
  - [ ] Handle partial overlaps
  - [ ] Handle multi-day windows
- [ ] Add edge case handling
  - [ ] Handle midnight boundaries
  - [ ] Handle week boundaries
  - [ ] Handle DST transitions
- [ ] Optimize performance
  - [ ] Cache processed schedules
  - [ ] Efficient time calculations

## Dev Notes

### Relevant Source Tree Info
- Working hours logic: `src/SmartScheduler.Domain/Scheduling/Services/WorkingHoursCalculator.cs`
- Timezone utilities: `src/SmartScheduler.Domain/Scheduling/Utilities/TimezoneHelper.cs`

### Architecture References
- **Working Hours:** See `docs/architecture/data-models.md` for WorkingHours model
- **Calendar Exceptions:** See ContractorCalendar in data models
- **Timezone:** IANA timezone support - see architecture spec

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Calculation Tests:** Test various working hours scenarios
- **Timezone Tests:** Test timezone conversions and DST
- **Exception Tests:** Test calendar exception handling

### UI Integration Notes
- Working hours displayed in contractor calendar view
- Available slots shown in recommendations
- UI already has calendar components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

