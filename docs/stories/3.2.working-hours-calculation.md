# Story 3.2: Working Hours Calculation

## Status
Ready for Review

## Story

**As a** system,
**I want** to calculate available time based on contractor working hours,
**so that** I can determine when contractors are available for jobs.

## Acceptance Criteria

1. **Weekly Schedule:** Process weekly working hours schedule
2. **Day-of-Week Logic:** Handle different schedules per day
3. **Timezone Handling:** Convert working hours to appropriate timezone
4. **Exception Handling:** Process calendar exceptions (holidays, overrides)
5. **Break Time:** Account for daily break minutes
6. **Time Window Filtering:** Filter available time by requested service window
7. **Multi-Day Windows:** Handle service windows spanning multiple days
8. **Efficient Calculation:** Fast calculation for real-time use
9. **Edge Cases:** Handle edge cases (midnight boundaries, DST transitions)
10. **Validation:** Validate working hours are consistent

## Tasks / Subtasks

- [x] Implement weekly schedule processing
  - [x] Process WorkingHours array
  - [x] Group by day of week
  - [x] Handle multiple time windows per day
- [x] Implement timezone conversion
  - [x] Convert working hours to UTC or job timezone
  - [x] Handle IANA timezone identifiers
  - [x] Handle DST transitions
- [x] Implement exception handling
  - [x] Process calendar exceptions
  - [x] Apply holiday blackouts
  - [x] Apply custom overrides
- [ ] Implement break time logic
  - [ ] Account for daily break minutes
  - [ ] Apply breaks between jobs
  - [ ] Configurable break duration
  - Note: Break time logic deferred to Story 3.6 (Fatigue Limits & Break Enforcement)
- [x] Implement time window filtering
  - [x] Filter available time by service window
  - [x] Handle partial overlaps
  - [x] Handle multi-day windows
- [x] Add edge case handling
  - [x] Handle midnight boundaries
  - [x] Handle week boundaries
  - [x] Handle DST transitions
- [x] Optimize performance
  - [x] Efficient time calculations
  - Note: Caching deferred to future optimization story if needed

## Dev Notes

### Relevant Source Tree Info
- Working hours logic: `src/SmartScheduler.Domain/Scheduling/Services/WorkingHoursCalculator.cs`
- Timezone utilities: `src/SmartScheduler.Domain/Scheduling/Utilities/TimezoneHelper.cs`

### Architecture References
- **Working Hours:** See `docs/architecture/data-models.md` for WorkingHours model
- **Calendar Exceptions:** See ContractorCalendar in data models
- **Timezone:** IANA timezone support - see architecture spec

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Calculation Tests:** Test various working hours scenarios
- **Timezone Tests:** Test timezone conversions and DST
- **Exception Tests:** Test calendar exception handling

### UI Integration Notes
- Working hours displayed in contractor calendar view
- Available slots shown in recommendations
- UI already has calendar components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `IWorkingHoursCalculator` interface and `WorkingHoursCalculator` implementation in `src/SmartScheduler.Domain/Scheduling/Services/`
- Implemented core working hours calculation that:
  - Processes weekly working hours schedules with support for multiple time windows per day
  - Handles timezone conversions using TimeZoneConverter library (IANA timezone support)
  - Processes calendar exceptions (holidays and overrides)
  - Filters available time by service window with support for multi-day windows
  - Handles edge cases (midnight boundaries, week boundaries, DST transitions)
- Created `GetWorkingHoursForDate` method to retrieve working hours for a specific date considering exceptions
- Break time logic deferred to Story 3.6 (Fatigue Limits & Break Enforcement) where it will be integrated with fatigue calculations
- Created comprehensive unit tests covering:
  - Basic working hours scenarios
  - Holiday exclusion
  - Override exception handling
  - Multi-day windows
  - Date-specific working hours retrieval
  - Edge cases
- All 8 unit tests pass successfully
- Calculator is efficient and ready for real-time use

### File List
- `src/SmartScheduler.Domain/Scheduling/Services/IWorkingHoursCalculator.cs` (new)
- `src/SmartScheduler.Domain/Scheduling/Services/WorkingHoursCalculator.cs` (new)
- `src/SmartScheduler.Domain.Tests/Scheduling/WorkingHoursCalculatorTests.cs` (new)

## QA Results
_To be populated by QA agent_

