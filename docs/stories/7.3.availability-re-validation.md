# Story 7.3: Availability Re-validation

## Status
Approved

## Story

**As a** system,
**I want** to re-validate contractor availability before assignment,
**so that** assignments don't conflict with recent changes.

## Acceptance Criteria

1. **Re-validation Logic:** Availability checked immediately before assignment
2. **Time Slot Validation:** Verify requested time slot is still feasible
3. **Conflict Detection:** Detect conflicts with recent assignments
4. **Concurrency Handling:** Handle concurrent assignment attempts
5. **Error Messages:** Clear error messages for conflicts
6. **Performance:** Re-validation doesn't significantly impact assignment time
7. **Integration:** Integrated with assignment flow
8. **Testing:** Comprehensive tests
9. **Documentation:** Re-validation process documented
10. **Monitoring:** Re-validation failures tracked

## Tasks / Subtasks

- [ ] Implement re-validation service
  - [ ] Create `IAvailabilityRevalidator` interface
  - [ ] Implement re-validation logic
- [ ] Check time slot feasibility
  - [ ] Verify slot is within working hours
  - [ ] Verify slot doesn't conflict with existing assignments
  - [ ] Verify slot accounts for travel buffers
- [ ] Check for conflicts
  - [ ] Query recent assignments
  - [ ] Detect overlapping time slots
  - [ ] Handle edge cases (boundary overlaps)
- [ ] Handle concurrency
  - [ ] Use database transactions
  - [ ] Use optimistic concurrency
  - [ ] Handle race conditions
- [ ] Generate error messages
  - [ ] Clear conflict messages
  - [ ] Include conflicting assignment details
  - [ ] Suggest alternatives
- [ ] Integrate with assignment
  - [ ] Call re-validation in AssignJobCommand
  - [ ] Reject assignment if validation fails
  - [ ] Proceed if validation passes
- [ ] Add unit tests
  - [ ] Test re-validation logic
  - [ ] Test conflict detection
  - [ ] Test concurrency handling
- [ ] Add monitoring
  - [ ] Track re-validation failures
  - [ ] Monitor conflict rates

## Dev Notes

### Relevant Source Tree Info
- Re-validation service: `src/SmartScheduler.Application/Scheduling/Services/AvailabilityRevalidator.cs`
- Integration: Used in AssignJobCommand handler

### Architecture References
- **Re-validation:** See `docs/prd/epic-7-booking-flow-assignconfirm.md`
- **Concurrency:** Handle concurrent assignments - see PRD
- **Availability:** Uses availability engine - see Epic 3

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Re-validation Tests:** Test logic, conflicts, concurrency
- **Integration Tests:** Test in assignment flow

### UI Integration Notes
- Re-validation happens server-side
- UI shows errors if validation fails
- UI may show alternative time slots

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

