# Story 8.3: Cancel Job API

## Status
Approved

## Story

**As a** dispatcher,
**I want** to cancel jobs via API,
**so that** I can remove jobs from the system when needed.

## Acceptance Criteria

1. **API Endpoint:** POST /jobs/{id}/cancel endpoint
2. **Job Status Update:** Job status updated to Cancelled
3. **Assignment Handling:** Assignment cancelled if exists
4. **Event Publishing:** JobCancelled event published
5. **Authorization:** Dispatcher and Admin can cancel
6. **Validation:** Cannot cancel completed jobs
7. **Error Handling:** Proper errors for invalid cancellations
8. **Response:** Updated job returned
9. **OpenAPI:** Endpoint documented
10. **Testing:** Comprehensive API tests

## Tasks / Subtasks

- [ ] Create cancel command
  - [ ] Create `CancelJobCommand`
  - [ ] Create command handler
- [ ] Implement cancellation logic
  - [ ] Update job status to Cancelled
  - [ ] Cancel assignment if exists
  - [ ] Update assignment status
- [ ] Add validation
  - [ ] Cannot cancel completed jobs
  - [ ] Validate job exists
  - [ ] Validate job can be cancelled
- [ ] Publish domain event
  - [ ] Create JobCancelled event
  - [ ] Publish event
  - [ ] Send via SignalR
- [ ] Create API endpoint
  - [ ] POST /jobs/{id}/cancel endpoint
  - [ ] Validate request
  - [ ] Return updated job
- [ ] Add authorization
  - [ ] Apply Dispatcher/Admin policy
- [ ] Add error handling
  - [ ] Handle invalid cancellation (400)
  - [ ] Handle not found (404)
- [ ] Add unit tests
  - [ ] Test cancellation logic
  - [ ] Test validation
  - [ ] Test error handling

## Dev Notes

### Relevant Source Tree Info
- API endpoint: `src/SmartScheduler.Api/Endpoints/Jobs/CancelEndpoint.cs`
- Command: `src/SmartScheduler.Application/Jobs/Commands/CancelJobCommand.cs`
- Domain event: `src/SmartScheduler.Domain/Jobs/Events/JobCancelled.cs`

### Architecture References
- **Cancel:** See `docs/prd/epic-8-reschedulecancel-calendar-integrity.md`
- **Domain Events:** See `docs/prd/domain-events-integrations.md` for JobCancelled event
- **Status:** Job status management - see Story 2.6

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/` and `src/SmartScheduler.Application.Tests/`
- **Cancel Tests:** Test cancellation logic, validation, error handling

### UI Integration Notes
- Cancel functionality in job details UI
- Frontend calls this endpoint
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

