# Story 4.3: ETA Matrix Service

## Status
Approved

## Story

**As a** system,
**I want** an ETA matrix service to calculate travel times efficiently,
**so that** I can get ETAs for multiple contractor-job pairs in batch.

## Acceptance Criteria

1. **Matrix Service:** Service to calculate ETAs for multiple pairs
2. **Batch Processing:** Process multiple distance/ETA requests efficiently
3. **ORS Matrix API:** Use ORS matrix API when available
4. **Fallback Strategy:** Fall back to individual requests if matrix unavailable
5. **Caching:** Cache matrix results
6. **Performance:** Efficient batch processing
7. **Error Handling:** Handle partial failures in matrix
8. **Integration:** Integrated with recommendations flow
9. **Optimization:** Optimize batch size for performance
10. **Documentation:** Matrix service usage documented

## Tasks / Subtasks

- [ ] Create matrix service
  - [ ] Create `IETAMatrixService` interface
  - [ ] Define batch calculation methods
- [ ] Implement ORS matrix integration
  - [ ] Use ORS matrix API for batch requests
  - [ ] Parse matrix response
  - [ ] Handle matrix API limitations
- [ ] Implement fallback strategy
  - [ ] Fall back to individual requests if needed
  - [ ] Handle matrix API unavailability
- [ ] Add caching
  - [ ] Cache matrix results
  - [ ] Use appropriate cache keys
  - [ ] Set cache TTL
- [ ] Optimize batch processing
  - [ ] Determine optimal batch size
  - [ ] Process batches efficiently
  - [ ] Handle large batches
- [ ] Add error handling
  - [ ] Handle partial matrix failures
  - [ ] Retry failed requests
  - [ ] Log errors
- [ ] Integrate with recommendations
  - [ ] Use matrix service in recommendations flow
  - [ ] Get ETAs for top candidates
- [ ] Create unit tests
  - [ ] Test matrix calculation
  - [ ] Test fallback behavior
  - [ ] Test error handling

## Dev Notes

### Relevant Source Tree Info
- Matrix service: `src/SmartScheduler.Application/Scheduling/Services/ETAMatrixService.cs`
- ORS integration: Uses OpenRouteServiceClient

### Architecture References
- **Matrix API:** ORS matrix API for batch requests - see `docs/prd/a-openrouteservice-ors.md`
- **Performance:** Batch processing for efficiency - see architecture
- **Caching:** Cache matrix results - see `docs/prd/caching-performance.md`

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Matrix Tests:** Test batch calculation, fallback
- **Performance Tests:** Test batch processing efficiency

### UI Integration Notes
- ETAs displayed in recommendations
- Frontend shows travel time in recommendation cards
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

