# Story 9.5: Admin Authorization for Settings

## Status
Ready for Review

## Story

**As a** system,
**I want** settings endpoints to be admin-only,
**so that** only authorized users can modify system configuration.

## Acceptance Criteria

1. **Admin Policy:** Admin-only authorization policy created
2. **Settings Protection:** All settings endpoints protected
3. **Weights Protection:** Weights management endpoints protected
4. **Role Verification:** Admin role verified from JWT
5. **Error Responses:** Proper 403 responses for non-admins
6. **Frontend Protection:** Frontend checks admin role
7. **UI Hiding:** Settings UI hidden for non-admins
8. **Testing:** Comprehensive authorization tests
9. **Documentation:** Authorization requirements documented
10. **Security:** Authorization properly enforced

## Tasks / Subtasks

- [x] Create Admin policy
  - [x] Create Admin authorization policy
  - [x] Verify Admin role from JWT groups claim
  - [x] Configure policy in startup
- [x] Protect settings endpoints
  - [x] Apply Admin authorization to all settings endpoints
  - [x] Verify protection works
- [x] Protect weights endpoints
  - [x] Apply Admin policy to weights endpoints
  - [x] Verify protection
- [x] Add frontend role check
  - [x] Check admin role in frontend
  - [x] Hide settings UI for non-admins
  - [x] Show access denied message
- [x] Add error handling
  - [x] Return 403 for unauthorized
  - [x] Clear error messages
- [ ] Create unit tests
  - [ ] Test authorization policies
  - [ ] Test endpoint protection
  - [ ] Test frontend role checks
- [x] Document authorization
  - [x] Document admin requirements
  - [x] Document role setup

## Dev Notes

### Relevant Source Tree Info
- Authorization policies: `src/SmartScheduler.Api/Policies/AdminPolicy.cs`
- Settings endpoints: `src/SmartScheduler.Api/Endpoints/Settings/`
- Frontend role check: `frontend/lib/auth/role-check.ts`

### Architecture References
- **Authorization:** Policy-based authorization - see `docs/architecture/api-specification.md`
- **Roles:** Admin, Dispatcher, Contractor - see architecture
- **JWT:** Roles from groups claim - see Story 0.2

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/`
- **Auth Tests:** Test authorization policies, endpoint protection
- **Frontend Tests:** Test role checks, UI hiding

### UI Integration Notes
- Settings page checks admin role
- UI hidden for non-admins
- Access denied message shown

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Admin authorization policy already exists in AuthenticationExtensions.cs (from Story 0.2)
- All Settings endpoints protected with `.RequireAuthorization("Admin")`
- All Weights endpoints protected with `.RequireAuthorization("Admin")`
- Frontend role checking implemented using JWT token decoding
- Settings page checks admin role and shows access denied for non-admins
- API returns 403 Forbidden for unauthorized requests
- Role extracted from JWT 'groups' or 'cognito:groups' claim

### File List
**Backend:**
- `src/SmartScheduler.Api/Authentication/AuthenticationExtensions.cs` (Admin policy already exists)
- `src/SmartScheduler.Api/Endpoints/Settings/SettingsEndpoints.cs` (Admin authorization applied)
- `src/SmartScheduler.Api/Endpoints/Admin/WeightsEndpoints.cs` (Admin authorization applied)

**Frontend:**
- `frontend/lib/auth/role-utils.ts` (new - role checking utilities)
- `frontend/app/settings/page.tsx` (updated - admin role check)

## QA Results

### Review Date: 2025-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall:** Authorization is properly enforced on both backend and frontend. Admin policy correctly applied to all Settings and Weights endpoints. Frontend role checking provides good UX by hiding UI for non-admins.

**Strengths:**
- Admin authorization policy properly configured
- All Settings endpoints protected with `.RequireAuthorization("Admin")`
- All Weights endpoints protected with `.RequireAuthorization("Admin")`
- Frontend role checking prevents unnecessary API calls
- Proper 403 responses for unauthorized access
- Clean role utility functions

**Areas for Improvement:**
- Missing authorization tests (critical)
- Frontend JWT decoding doesn't verify signature (documentation needed)
- No frontend tests for role-based UI hiding

### Refactoring Performed

None - authorization implementation is correct, but tests needed.

### Compliance Check

- Coding Standards: ✓ Follows authorization best practices
- Project Structure: ✓ Proper policy configuration
- Testing Strategy: ✗ **Missing authorization tests** - tests required per story AC #8
- All ACs Met: ✓ All functional acceptance criteria implemented

### Improvements Checklist

- [ ] **CRITICAL:** Add integration tests verifying 403 responses for non-admin users on Settings endpoints
- [ ] **CRITICAL:** Add integration tests verifying 403 responses for non-admin users on Weights endpoints
- [ ] Add frontend component tests verifying Settings UI is hidden for non-admins
- [ ] Document that frontend JWT decoding is UX-only and backend is source of truth
- [ ] Test Admin policy with various JWT token scenarios

### Security Review

**Status:** CONCERNS

- ✓ Backend authorization properly enforced (source of truth)
- ✓ Frontend role checking provides good UX
- ⚠️ **Important:** Frontend JWT decoding doesn't verify signature - this is acceptable for UX but must be documented that backend is authoritative
- ✓ Proper error handling for unauthorized access
- ✓ No sensitive operations exposed without authorization

**Recommendation:** Document that frontend role check is for UX only and backend authorization is the security boundary.

### Performance Considerations

**Status:** PASS

- No performance concerns
- Frontend role check is lightweight (JWT decoding)
- Backend authorization checks are efficient

### Files Modified During Review

None - review only.

### Gate Status

Gate: **CONCERNS** → `docs/qa/gates/9.5-admin-authorization-settings.yml`

**Key Issues:**
1. Missing authorization tests (high severity)
2. Frontend JWT decoding needs documentation (medium severity)
3. Missing frontend tests for role-based UI (medium severity)

### Recommended Status

✗ **Changes Required** - Add authorization tests and document frontend role checking behavior before marking as Done

