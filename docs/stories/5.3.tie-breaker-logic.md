# Story 5.3: Tie-Breaker Logic

## Status
Approved

## Story

**As a** system,
**I want** tie-breaker logic to order contractors with equal scores,
**so that** recommendations have a consistent and fair ordering.

## Acceptance Criteria

1. **Tie Detection:** Detect when contractors have equal final scores
2. **Tie-Breaker Order:** Apply tie-breakers in order: (1) earliest feasible start, (2) lower same-day utilization, (3) shortest next-leg travel
3. **Earliest Start:** Compare earliest feasible start times
4. **Utilization Comparison:** Compare same-day utilization percentages
5. **Travel Comparison:** Compare shortest next-leg travel times
6. **Deterministic:** Same inputs produce same ordering
7. **Performance:** Efficient tie-breaking
8. **Integration:** Integrated with ranking
9. **Testing:** Comprehensive tests
10. **Documentation:** Tie-breaker logic documented

## Tasks / Subtasks

- [ ] Implement tie detection
  - [ ] Detect equal final scores
  - [ ] Group contractors by score
- [ ] Implement earliest start tie-breaker
  - [ ] Get earliest feasible start for each contractor
  - [ ] Compare start times
  - [ ] Order by earliest first
- [ ] Implement utilization tie-breaker
  - [ ] Calculate same-day utilization
  - [ ] Compare utilization percentages
  - [ ] Order by lower utilization first
- [ ] Implement travel tie-breaker
  - [ ] Calculate shortest next-leg travel
  - [ ] Compare travel times
  - [ ] Order by shortest travel first
- [ ] Apply tie-breaker chain
  - [ ] Apply tie-breakers in order
  - [ ] Only apply next tie-breaker if previous doesn't resolve
  - [ ] Handle all ties resolved
- [ ] Add unit tests
  - [ ] Test each tie-breaker
  - [ ] Test tie-breaker chain
  - [ ] Test deterministic ordering
- [ ] Integrate with ranking
  - [ ] Apply tie-breakers after scoring
  - [ ] Maintain final ranking
- [ ] Document logic
  - [ ] Document tie-breaker order
  - [ ] Document each tie-breaker

## Dev Notes

### Relevant Source Tree Info
- Tie-breaker service: `src/SmartScheduler.Application/Recommendations/Services/TieBreakerService.cs`
- Integration: Used in ranking flow

### Architecture References
- **Tie-Breakers:** See `docs/prd.md` section "Tie-breakers & Fairness"
- **Order:** (1) earliest start, (2) lower utilization, (3) shortest travel - see PRD
- **Fairness:** Soft rotation boost - see Epic 5.4

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Tie-Breaker Tests:** Test each tie-breaker, chain, deterministic ordering

### UI Integration Notes
- Tie-breakers affect recommendation order
- Order displayed in recommendation list
- UI shows ranked recommendations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

