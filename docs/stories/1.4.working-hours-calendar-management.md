# Story 1.4: Working Hours & Calendar Management

## Status
Approved

## Story

**As a** dispatcher or admin,
**I want** to manage contractor working hours and calendar exceptions,
**so that** the availability engine can accurately calculate available time slots.

## Acceptance Criteria

1. **Working Hours CRUD:** Create, update, delete working hours for contractors
2. **Calendar Exceptions:** Add holidays and custom overrides to contractor calendars
3. **Validation:** Working hours validated (start < end, valid dayOfWeek, valid timezone)
4. **API Endpoints:** Endpoints for managing working hours and calendar
5. **Default Break Time:** Configurable daily break minutes (default 30)
6. **Timezone Support:** Working hours stored with IANA timezone
7. **Bulk Updates:** Ability to update multiple days at once
8. **Calendar View:** API supports calendar view queries
9. **Data Persistence:** Changes persisted to database
10. **Authorization:** Only Admin and Dispatcher can modify calendars

## Tasks / Subtasks

- [ ] Extend contractor API
  - [ ] Add working hours to CreateContractorRequest
  - [ ] Add working hours to UpdateContractorRequest
  - [ ] Add calendar exceptions to update requests
- [ ] Create working hours DTOs
  - [ ] Create `WorkingHoursDto`
  - [ ] Create `CalendarExceptionDto`
  - [ ] Create `ContractorCalendarDto`
- [ ] Implement validation
  - [ ] Validate dayOfWeek (0-6)
  - [ ] Validate time format (HH:mm)
  - [ ] Validate start < end
  - [ ] Validate timezone (IANA format)
- [ ] Add calendar management endpoints
  - [ ] `PUT /contractors/{id}/working-hours` - update working hours
  - [ ] `POST /contractors/{id}/calendar/exceptions` - add exception
  - [ ] `DELETE /contractors/{id}/calendar/exceptions/{date}` - remove exception
- [ ] Implement domain logic
  - [ ] Working hours aggregation
  - [ ] Exception override logic
  - [ ] Default break time handling
- [ ] Update EF Core configuration
  - [ ] Configure value object mapping for WorkingHours
  - [ ] Configure calendar exception collection
- [ ] Add authorization
  - [ ] Apply Admin/Dispatcher policies
  - [ ] Verify contractor ownership for contractors

## Dev Notes

### Relevant Source Tree Info
- API endpoints: `src/SmartScheduler.Api/Endpoints/Contractors/`
- Commands: `src/SmartScheduler.Application/Contracts/Commands/`
- Domain: `src/SmartScheduler.Domain/Contracts/ValueObjects/WorkingHours.cs`

### Architecture References
- **Data Models:** See `docs/architecture/data-models.md` for WorkingHours and ContractorCalendar
- **Timezone:** IANA timezone support - see architecture spec

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/`
- **Validation Tests:** Test working hours validation rules
- **API Tests:** Test calendar management endpoints

### UI Integration Notes
- Frontend has `WorkingScheduleSettings` component (see `frontend/components/contractors/working-schedule-settings.tsx`)
- Frontend has `ExceptionsManager` component (see `frontend/components/contractors/exceptions-manager.tsx`)
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

