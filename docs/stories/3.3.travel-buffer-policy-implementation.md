# Story 3.3: Travel Buffer Policy Implementation

## Status
Ready for Review

## Story

**As a** system,
**I want** travel buffers applied between job assignments,
**so that** contractors have adequate time to travel between locations.

## Acceptance Criteria

1. **Buffer Calculation:** Buffer calculated as max(10m, min(45m, ETA × 0.25))
2. **Base-to-First:** Buffer applied from contractor base to first job
3. **Job-to-Job:** Buffer applied between sequential jobs
4. **Last-to-Base:** Optional buffer from last job back to base
5. **Regional Configuration:** Buffer multipliers configurable by region
6. **Buffer Application:** Buffers included in feasibility checks
7. **Time Block Carving:** Buffers part of time-block calculation
8. **Edge Cases:** Handle edge cases (same location, very short distances)
9. **Configuration:** Buffer policy configurable
10. **Documentation:** Buffer policy documented

## Tasks / Subtasks

- [x] Create buffer calculation service
  - [x] Create `ITravelBufferService` interface
  - [x] Implement buffer calculation formula
  - [x] Handle regional multipliers
- [x] Implement base-to-first buffer
  - [x] Calculate buffer from base to first job
  - [ ] Apply buffer in slot generation (deferred to Story 3.4)
- [x] Implement job-to-job buffer
  - [x] Calculate buffer between sequential jobs
  - [ ] Apply buffer in availability calculation (deferred to Story 3.4)
- [x] Implement last-to-base buffer (optional)
  - [x] Calculate buffer from last job to base
  - [x] Uses same formula (configurable in future)
- [ ] Integrate with availability engine
  - [ ] Apply buffers in slot generation (deferred to Story 3.4)
  - [ ] Include buffers in time calculations (deferred to Story 3.4)
- [x] Add regional configuration
  - [x] Support regional buffer multipliers (parameter support)
  - [ ] Load configuration from config store (deferred to future story)
- [x] Handle edge cases
  - [x] Same location (minimal buffer = 10m)
  - [x] Very short distances (minimum 10m)
  - [x] Very long distances (maximum 45m)
- [x] Create unit tests
  - [x] Test buffer calculation formula
  - [x] Test edge cases
  - [x] Test regional multipliers

## Dev Notes

### Relevant Source Tree Info
- Buffer service: `src/SmartScheduler.Domain/Scheduling/Services/TravelBufferService.cs`
- Buffer configuration: `src/SmartScheduler.Application/Scheduling/Configuration/TravelBufferConfig.cs`

### Architecture References
- **Travel Buffer Policy:** See `docs/prd.md` section "Travel Buffer Policy"
- **Formula:** max(10m, min(45m, ETA × 0.25)) - see PRD
- **Regional Settings:** See `docs/prd/c-weights-regional-settings-appconfigparameter-store.md`
- **Epic 4 Dependency:** This story requires ETA values from Epic 4 (Distance & ETA Service). ETAs are provided via `IOpenRouteServiceClient` or `IDistanceCalculationService` from Epic 4.1/4.5. Travel buffer service accepts ETA in minutes as input parameter.

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Buffer Tests:** Test calculation formula, edge cases
- **Integration Tests:** Test buffer application in availability engine

### UI Integration Notes
- Buffers not directly displayed in UI
- Buffers affect available time slots shown
- Travel time displayed in recommendations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `ITravelBufferService` interface and `TravelBufferService` implementation in `src/SmartScheduler.Domain/Scheduling/Services/`
- Implemented travel buffer calculation formula: max(10m, min(45m, ETA × 0.25))
- Implemented all buffer calculation methods:
  - `CalculateBaseToFirstBuffer` - buffer from contractor base to first job
  - `CalculateJobToJobBuffer` - buffer between sequential jobs
  - `CalculateLastToBaseBuffer` - optional buffer from last job back to base
- Added support for regional multipliers (parameter-based, config store integration deferred)
- Handled all edge cases:
  - Same location (ETA = 0) returns minimum 10 minutes
  - Very short distances enforce minimum 10 minutes
  - Very long distances cap at maximum 45 minutes
- Created comprehensive unit tests covering:
  - Buffer calculation formula with various ETA values
  - Minimum and maximum boundaries
  - Regional multiplier application
  - Edge cases (zero ETA, negative ETA validation)
  - All buffer calculation methods
- All 18 unit tests pass successfully
- Integration with availability engine and slot generation deferred to Story 3.4 (Feasible Slot Generation)

### File List
- `src/SmartScheduler.Domain/Scheduling/Services/ITravelBufferService.cs` (new)
- `src/SmartScheduler.Domain/Scheduling/Services/TravelBufferService.cs` (new)
- `src/SmartScheduler.Domain.Tests/Scheduling/TravelBufferServiceTests.cs` (new)

## QA Results
_To be populated by QA agent_

