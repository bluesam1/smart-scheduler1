# Story 6.5: Real-time Recommendation Updates (SignalR)

## Status
Approved

## MVP Priority
**CRITICAL** - Required for MVP (PRD line 318: RecommendationReady event). Depends on Story FE.2. Enables real-time recommendation updates for dispatcher UI.

## Story

**As a** dispatcher,
**I want** real-time updates when recommendations are ready,
**so that** I see new recommendations immediately without manual refresh.

## Acceptance Criteria

1. **SignalR Event:** RecommendationReady event published via SignalR
2. **Event Publishing:** Event published after recommendations generated
3. **Group Targeting:** Event sent to appropriate dispatcher groups
4. **Event Payload:** Event includes jobId and recommendation summary
5. **Frontend Integration:** Frontend subscribes to RecommendationReady events
6. **UI Updates:** Recommendations sheet updates on event
7. **Connection Handling:** Graceful handling of connection failures
8. **Event Ordering:** Events processed in order
9. **Performance:** Event publishing doesn't impact API performance
10. **Testing:** Comprehensive tests

## Tasks / Subtasks

- [x] Implement RecommendationReady event
  - [x] Create event structure (already exists in SignalR infrastructure)
  - [x] Include jobId and summary (event payload includes jobId, requestId, region, configVersion, generatedAt)
  - [x] Define event schema (defined in signalr-types.ts)
- [x] Publish event after recommendations
  - [x] Publish after recommendations generated
  - [x] Send to dispatcher groups (dispatch/Default for MVP)
  - [x] Include event payload
- [x] Configure SignalR groups
  - [x] Ensure dispatchers in correct groups (handled by SignalRProvider in layout)
  - [x] Handle group membership (handled by RecommendationsHub)
- [x] Update frontend SignalR client
  - [x] Subscribe to RecommendationReady event (SignalR client already supports this)
  - [x] Handle event reception (added to RecommendationsSheet)
  - [x] Update recommendations UI (refreshes recommendations on event)
- [x] Add connection handling
  - [x] Handle connection failures (handled by SignalR client with automatic reconnection)
  - [x] Implement reconnection logic (exponential backoff in SignalR client)
  - [x] Handle event ordering (SignalR handles this)
- [x] Add error handling
  - [x] Handle event publishing errors (fire-and-forget with error logging)
  - [x] Log errors (errors logged but don't block response)
  - [x] Graceful degradation (app continues if SignalR unavailable)
- [x] Optimize performance
  - [x] Async event publishing (fire-and-forget Task.Run)
  - [x] Don't block API response
- [ ] Create unit tests
  - [ ] Test event publishing
  - [ ] Test group targeting
  - [ ] Test frontend integration

## Dev Notes

### Relevant Source Tree Info
- SignalR hub: `src/SmartScheduler.Realtime/Hubs/RecommendationsHub.cs`
- Event publishing: `src/SmartScheduler.Application/Recommendations/Services/RecommendationService.cs`
- Frontend client: `frontend/lib/realtime/signalr-client.ts`

### Architecture References
- **SignalR Events:** See `docs/prd/realtime.md` for RecommendationReady event
- **SignalR Setup:** See Story 0.3 for SignalR setup
- **Real-time:** SignalR for real-time updates - see architecture

### Testing Standards
- **Test Location:** `src/SmartScheduler.Realtime.Tests/` and `frontend/__tests__/`
- **Event Tests:** Test event publishing, group targeting
- **Integration Tests:** Test end-to-end real-time flow

### UI Integration Notes
- Frontend needs SignalR client connection
- RecommendationsSheet updates on RecommendationReady event
- UI components already exist - needs SignalR integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Added IRealtimePublisher to GetRecommendationsQueryHandler
- Publish RecommendationReady event after recommendations generated (fire-and-forget, async)
- Event published to dispatch/Default group (MVP uses default region)
- Event includes: jobId, requestId, region, configVersion, generatedAt
- Frontend SignalR client already exists and supports RecommendationReady events
- Updated RecommendationsSheet to subscribe to RecommendationReady events
- Recommendations refresh automatically when RecommendationReady event received for current job
- Updated layout to use "Default" region to match backend
- Event publishing is non-blocking (fire-and-forget) and errors are logged but don't affect API response
- SignalR connection handling, reconnection, and error handling already implemented in SignalR client

### File List
- src/SmartScheduler.Application/Recommendations/Handlers/GetRecommendationsQueryHandler.cs (modified - added SignalR event publishing)
- src/SmartScheduler.Application/SmartScheduler.Application.csproj (modified - added Realtime project reference)
- frontend/components/jobs/recommendations-sheet.tsx (modified - added SignalR event subscription)
- frontend/app/layout.tsx (modified - updated region to "Default" to match backend)

## QA Results
_To be populated by QA agent_

