# Story 3.5: Calendar Exception Handling

## Status
Approved

## Story

**As a** system,
**I want** to handle calendar exceptions (holidays, custom overrides),
**so that** availability calculations account for contractor-specific schedule changes.

## Acceptance Criteria

1. **Holiday Handling:** Holidays block out entire days
2. **Custom Overrides:** Custom working hours override default schedule
3. **Exception Priority:** Exceptions take precedence over regular schedule
4. **Exception Application:** Exceptions applied correctly in availability calculation
5. **Date Matching:** Exceptions matched by date accurately
6. **Timezone Handling:** Exceptions respect timezone
7. **Edge Cases:** Handle overlapping exceptions, invalid dates
8. **Performance:** Efficient exception lookup
9. **Validation:** Exceptions validated on creation
10. **Integration:** Exceptions integrated with availability engine

## Tasks / Subtasks

- [ ] Implement holiday handling
  - [ ] Load holidays from contractor calendar
  - [ ] Block out holiday dates
  - [ ] Handle timezone for holidays
- [ ] Implement custom override handling
  - [ ] Load custom working hours overrides
  - [ ] Apply overrides for specific dates
  - [ ] Override takes precedence over regular schedule
- [ ] Create exception matching logic
  - [ ] Match exceptions by date
  - [ ] Handle date ranges if needed
  - [ ] Efficient date lookup
- [ ] Integrate with availability engine
  - [ ] Apply exceptions in slot generation
  - [ ] Exceptions override regular schedule
  - [ ] Handle exception conflicts
- [ ] Add validation
  - [ ] Validate exception dates
  - [ ] Validate override working hours
  - [ ] Prevent invalid exceptions
- [ ] Handle edge cases
  - [ ] Overlapping exceptions
  - [ ] Invalid dates
  - [ ] Timezone mismatches
- [ ] Optimize performance
  - [ ] Cache exception lookups
  - [ ] Efficient date matching

## Dev Notes

### Relevant Source Tree Info
- Exception handling: `src/SmartScheduler.Domain/Scheduling/Services/CalendarExceptionHandler.cs`
- Calendar exceptions: `src/SmartScheduler.Domain/Contracts/ValueObjects/CalendarException.cs`

### Architecture References
- **Calendar Exceptions:** See `docs/architecture/data-models.md` for CalendarException model
- **Contractor Calendar:** See ContractorCalendar in data models
- **Availability:** Exceptions affect availability - see Epic 3

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Exception Tests:** Test holiday blocking, override application
- **Edge Case Tests:** Test overlapping exceptions, invalid dates

### UI Integration Notes
- Exceptions managed in contractor calendar UI
- Frontend has `ExceptionsManager` component
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

