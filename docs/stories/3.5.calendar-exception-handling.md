# Story 3.5: Calendar Exception Handling

## Status
Ready for Review

## Story

**As a** system,
**I want** to handle calendar exceptions (holidays, custom overrides),
**so that** availability calculations account for contractor-specific schedule changes.

## Acceptance Criteria

1. **Holiday Handling:** Holidays block out entire days
2. **Custom Overrides:** Custom working hours override default schedule
3. **Exception Priority:** Exceptions take precedence over regular schedule
4. **Exception Application:** Exceptions applied correctly in availability calculation
5. **Date Matching:** Exceptions matched by date accurately
6. **Timezone Handling:** Exceptions respect timezone
7. **Edge Cases:** Handle overlapping exceptions, invalid dates
8. **Performance:** Efficient exception lookup
9. **Validation:** Exceptions validated on creation
10. **Integration:** Exceptions integrated with availability engine

## Tasks / Subtasks

- [x] Implement holiday handling
  - [x] Load holidays from contractor calendar
  - [x] Block out holiday dates
  - [x] Handle timezone for holidays
- [x] Implement custom override handling
  - [x] Load custom working hours overrides
  - [x] Apply overrides for specific dates
  - [x] Override takes precedence over regular schedule
- [x] Create exception matching logic
  - [x] Match exceptions by date
  - [x] Handle date ranges if needed
  - [x] Efficient date lookup
- [x] Integrate with availability engine
  - [x] Apply exceptions in slot generation
  - [x] Exceptions override regular schedule
  - [x] Handle exception conflicts
- [x] Add validation
  - [x] Validate exception dates
  - [x] Validate override working hours
  - [x] Prevent invalid exceptions
- [x] Handle edge cases
  - [x] Overlapping exceptions
  - [x] Invalid dates
  - [x] Timezone mismatches
- [x] Optimize performance
  - [x] Efficient date matching
  - Note: Exception handling implemented in WorkingHoursCalculator and AvailabilityEngine

## Dev Notes

### Relevant Source Tree Info
- Exception handling: `src/SmartScheduler.Domain/Scheduling/Services/CalendarExceptionHandler.cs`
- Calendar exceptions: `src/SmartScheduler.Domain/Contracts/ValueObjects/CalendarException.cs`

### Architecture References
- **Calendar Exceptions:** See `docs/architecture/data-models.md` for CalendarException model
- **Contractor Calendar:** See ContractorCalendar in data models
- **Availability:** Exceptions affect availability - see Epic 3

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Exception Tests:** Test holiday blocking, override application
- **Edge Case Tests:** Test overlapping exceptions, invalid dates

### UI Integration Notes
- Exceptions managed in contractor calendar UI
- Frontend has `ExceptionsManager` component
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - Functionality already implemented in WorkingHoursCalculator

### Completion Notes List
- Calendar exception handling is implemented in `WorkingHoursCalculator` and integrated with `AvailabilityEngine`
- Holiday handling: Holidays from `ContractorCalendar.Holidays` block out entire days in availability calculations
- Custom override handling: Override exceptions from `ContractorCalendar.Exceptions` replace regular working hours for specific dates
- Exception priority: Exceptions take precedence over regular schedule (holidays block, overrides replace)
- Date matching: Exceptions matched by `DateOnly` for accurate date comparison
- Timezone handling: Exceptions respect contractor timezone when processing dates
- Validation: `CalendarException` value object validates that override exceptions include working hours
- Edge cases handled: Overlapping exceptions (holiday takes precedence), invalid dates prevented by value object validation
- Integration: Exceptions automatically applied in availability engine through WorkingHoursCalculator
- Performance: Efficient date lookup using LINQ FirstOrDefault with date comparison
- All functionality tested through WorkingHoursCalculatorTests and AvailabilityEngineTests

### File List
- Calendar exception handling implemented in:
  - `src/SmartScheduler.Domain/Scheduling/Services/WorkingHoursCalculator.cs` (existing)
  - `src/SmartScheduler.Domain/Scheduling/Services/AvailabilityEngine.cs` (existing)
  - `src/SmartScheduler.Domain/Contracts/ValueObjects/CalendarException.cs` (existing)
  - `src/SmartScheduler.Domain/Contracts/ValueObjects/ContractorCalendar.cs` (existing)

## QA Results
_To be populated by QA agent_

