# Story 2.6: Job Status Management

## Status
Ready for Review

## Story

**As a** dispatcher,
**I want** to manage job status transitions,
**so that** jobs progress through their lifecycle correctly.

## Acceptance Criteria

1. **Status Enum:** JobStatus enum with values (Created, Assigned, InProgress, Completed, Cancelled)
2. **Status Transitions:** Valid status transitions enforced
3. **Status Updates:** API endpoints to update job status
4. **Assignment Status:** Computed assignment status (Unassigned, Partially Assigned, Assigned)
5. **Status Validation:** Invalid transitions rejected with clear errors
6. **Domain Events:** Status changes trigger appropriate domain events
7. **Status History:** Status changes logged (optional, future enhancement)
8. **Authorization:** Appropriate roles can update status
9. **Automatic Transitions:** Some status changes automatic (e.g., Assigned when assignment created)
10. **Status Display:** Status displayed correctly in UI

## Tasks / Subtasks

- [x] Create JobStatus enum
  - [x] Define status values in domain (already done in Story 2.1)
  - [x] Document valid transitions (already done in Story 2.1)
- [x] Implement status transition logic
  - [x] Create status transition validation (already done in Story 2.1)
  - [x] Define valid transition rules (already done in Story 2.1)
  - [x] Reject invalid transitions (already done in Story 2.1)
- [x] Create status update command
  - [x] Create `UpdateJobStatusCommand`
  - [x] Create command handler
  - [x] Validate status transition
- [x] Create API endpoint
  - [x] `PUT /jobs/{id}/status` endpoint
  - [x] Accept new status in request body
  - [x] Return updated job
- [x] Implement assignment status computation
  - [x] Compute assignment status from Assignment records (already done in Story 2.1)
  - [x] Update assignment status on assignment changes (already done in Story 2.1)
- [x] Add domain events
  - [x] Trigger events on status changes (already done in Story 2.1)
  - [x] JobAssigned, JobCompleted, JobCancelled events (already done in Story 2.1)
- [x] Add authorization
  - [x] Dispatcher can update status (endpoint requires Dispatcher authorization)
  - [x] Some statuses may be system-only (handled by domain validation)
- [x] Update job queries
  - [x] Include status in job DTOs (already done in Story 2.2)
  - [x] Filter by status in list queries (already done in Story 2.2)

## Dev Notes

### Relevant Source Tree Info
- Status enum: `src/SmartScheduler.Domain/Jobs/Enums/JobStatus.cs`
- Command: `src/SmartScheduler.Application/Jobs/Commands/UpdateJobStatusCommand.cs`
- API endpoint: `src/SmartScheduler.Api/Endpoints/Jobs/`

### Architecture References
- **Data Models:** See `docs/architecture/data-models.md` for JobStatus type
- **Domain Events:** See `docs/prd/domain-events-integrations.md` for job events
- **Status Flow:** See PRD for job lifecycle

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Status Tests:** Test valid/invalid transitions
- **API Tests:** Test status update endpoint

### UI Integration Notes
- Frontend displays job status in JobsTable
- Status badges/colors already implemented
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Most status management already implemented in Story 2.1 (JobStatus enum, status transitions, domain events, assignment status computation)
- Created UpdateJobStatusCommand and handler for status updates
- Created PUT /jobs/{id}/status API endpoint with proper authorization
- Status transitions are validated by domain logic (Job.UpdateStatus method)
- Invalid transitions return 400 Bad Request with clear error message
- Endpoint requires Dispatcher authorization
- Job DTOs already include status (from Story 2.2)
- Job queries already support filtering by status (from Story 2.2)

### File List
**Created:**
- `src/SmartScheduler.Application/Contracts/Commands/UpdateJobStatusCommand.cs` - Command for updating job status
- `src/SmartScheduler.Application/Contracts/Handlers/UpdateJobStatusCommandHandler.cs` - Handler for status update command

**Modified:**
- `src/SmartScheduler.Api/Endpoints/Jobs/JobEndpoints.cs` - Added PUT /jobs/{id}/status endpoint

## QA Results
_To be populated by QA agent_

