# Story 2.6: Job Status Management

## Status
Approved

## Story

**As a** dispatcher,
**I want** to manage job status transitions,
**so that** jobs progress through their lifecycle correctly.

## Acceptance Criteria

1. **Status Enum:** JobStatus enum with values (Created, Assigned, InProgress, Completed, Cancelled)
2. **Status Transitions:** Valid status transitions enforced
3. **Status Updates:** API endpoints to update job status
4. **Assignment Status:** Computed assignment status (Unassigned, Partially Assigned, Assigned)
5. **Status Validation:** Invalid transitions rejected with clear errors
6. **Domain Events:** Status changes trigger appropriate domain events
7. **Status History:** Status changes logged (optional, future enhancement)
8. **Authorization:** Appropriate roles can update status
9. **Automatic Transitions:** Some status changes automatic (e.g., Assigned when assignment created)
10. **Status Display:** Status displayed correctly in UI

## Tasks / Subtasks

- [ ] Create JobStatus enum
  - [ ] Define status values in domain
  - [ ] Document valid transitions
- [ ] Implement status transition logic
  - [ ] Create status transition validation
  - [ ] Define valid transition rules
  - [ ] Reject invalid transitions
- [ ] Create status update command
  - [ ] Create `UpdateJobStatusCommand`
  - [ ] Create command handler
  - [ ] Validate status transition
- [ ] Create API endpoint
  - [ ] `PUT /jobs/{id}/status` endpoint
  - [ ] Accept new status in request body
  - [ ] Return updated job
- [ ] Implement assignment status computation
  - [ ] Compute assignment status from Assignment records
  - [ ] Update assignment status on assignment changes
- [ ] Add domain events
  - [ ] Trigger events on status changes
  - [ ] JobAssigned, JobCompleted, JobCancelled events
- [ ] Add authorization
  - [ ] Dispatcher can update status
  - [ ] Some statuses may be system-only
- [ ] Update job queries
  - [ ] Include status in job DTOs
  - [ ] Filter by status in list queries

## Dev Notes

### Relevant Source Tree Info
- Status enum: `src/SmartScheduler.Domain/Jobs/Enums/JobStatus.cs`
- Command: `src/SmartScheduler.Application/Jobs/Commands/UpdateJobStatusCommand.cs`
- API endpoint: `src/SmartScheduler.Api/Endpoints/Jobs/`

### Architecture References
- **Data Models:** See `docs/architecture/data-models.md` for JobStatus type
- **Domain Events:** See `docs/prd/domain-events-integrations.md` for job events
- **Status Flow:** See PRD for job lifecycle

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Status Tests:** Test valid/invalid transitions
- **API Tests:** Test status update endpoint

### UI Integration Notes
- Frontend displays job status in JobsTable
- Status badges/colors already implemented
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

