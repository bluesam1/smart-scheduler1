# Story 0.7: Cognito Login Frontend Integration

## Status
Ready for Review

## Story

**As a** dispatcher or contractor,
**I want** to log in using a custom login form with Cognito authentication,
**so that** I can access the SmartScheduler system and handle forced password changes seamlessly.

## Acceptance Criteria

1. **Custom Login Form:** Custom login form implemented (not using Cognito Hosted UI)
2. **Cognito SDK Integration:** AWS Cognito SDK integrated for direct authentication
3. **Login Flow:** Users can log in with email and password
4. **Token Storage:** Access tokens stored securely (session storage or in-memory)
5. **Forced Password Change:** System handles NEW_PASSWORD_REQUIRED challenge from Cognito
6. **Password Change UI:** Password change form displayed when required
7. **Token Management:** Tokens included in API requests automatically
8. **Error Handling:** Clear error messages for authentication failures
9. **Loading States:** Loading indicators during authentication
10. **Session Management:** User session persists across page refreshes
11. **Logout:** Users can log out and clear session
12. **Route Protection:** Protected routes redirect to login when unauthenticated
13. **UI Consistency:** Login and password change forms match the look and feel of the rest of the application, following the UI Implementation Specification

## Tasks / Subtasks

- [x] Install Cognito SDK
  - [x] Install `amazon-cognito-identity-js` or `@aws-amplify/auth` package
  - [x] Configure Cognito client with User Pool ID and App Client ID
- [x] Create authentication context/provider
  - [x] Create `frontend/lib/auth/auth-context.tsx` or similar
  - [x] Implement authentication state management
  - [x] Provide login, logout, and token access functions
- [x] Implement login form component
  - [x] Create `frontend/components/auth/login-form.tsx`
  - [x] Add email and password input fields
  - [x] Add form validation (email format, password requirements)
  - [x] Handle form submission with Cognito authentication
  - [x] Display loading state during authentication
  - [x] Display error messages for failed login attempts
  - [x] Use shadcn/ui components (Button, Input, Card, etc.) for consistency
  - [x] Apply design system colors, typography, and spacing from UI spec
  - [x] Match styling patterns used in other forms throughout the application
- [x] Implement forced password change flow
  - [x] Detect NEW_PASSWORD_REQUIRED challenge from Cognito
  - [x] Create `frontend/components/auth/change-password-form.tsx`
  - [x] Display password change form when challenge is detected
  - [x] Handle new password submission
  - [x] Validate new password meets Cognito requirements
  - [x] Complete authentication after password change
  - [x] Use same UI components and styling as login form for consistency
  - [x] Match visual design and layout patterns from login form
- [x] Implement token storage and management
  - [x] Store access token securely (session storage or in-memory)
  - [x] Store refresh token for token renewal
  - [x] Implement token refresh logic
  - [x] Clear tokens on logout
- [x] Create authentication middleware/guard
  - [x] Create route protection middleware
  - [x] Redirect unauthenticated users to login
  - [x] Preserve intended destination after login
- [x] Integrate with API client
  - [x] Update API client factory to use stored access token
  - [x] Include token in Authorization header automatically
  - [x] Handle 401 responses (token expired/invalid)
- [x] Implement logout functionality
  - [x] Add logout button/action
  - [x] Clear tokens and session
  - [x] Redirect to login page
- [x] Configure environment variables
  - [x] Add `NEXT_PUBLIC_COGNITO_USER_POOL_ID` to `.env.local`
  - [x] Add `NEXT_PUBLIC_COGNITO_APP_CLIENT_ID` to `.env.local`
  - [x] Add `NEXT_PUBLIC_COGNITO_REGION` to `.env.local`
  - [x] Document environment setup
- [x] Add error handling
  - [x] Handle network errors
  - [x] Handle invalid credentials
  - [x] Handle account locked/disabled
  - [x] Display user-friendly error messages
- [x] Create login page
  - [x] Create `frontend/app/login/page.tsx` or similar route
  - [x] Integrate login form component
  - [x] Add branding/styling per UI spec
  - [x] Ensure consistent look and feel with rest of application
  - [x] Use design system colors, typography, and spacing from UI spec
  - [x] Match component styling patterns used in other pages
- [ ] Testing
  - [ ] Test successful login flow
  - [ ] Test forced password change flow
  - [ ] Test error handling (invalid credentials, network errors)
  - [ ] Test token storage and retrieval
  - [ ] Test logout functionality
  - [ ] Test route protection

## Dev Notes

### Relevant Source Tree Info
- Frontend location: `frontend/` (Next.js 14+ App Router)
- Authentication context: `frontend/lib/auth/auth-context.tsx` (to be created)
- Login form: `frontend/components/auth/login-form.tsx` (to be created)
- Password change form: `frontend/components/auth/change-password-form.tsx` (to be created)
- Login page: `frontend/app/login/page.tsx` (to be created)
- Environment variables: `frontend/.env.local`

### Architecture References
- **Authentication:** Amazon Cognito (User Pool) - see `docs/architecture/tech-stack.md`
- **Backend Integration:** Story 0.2 implements JWT validation - tokens from this story will be validated by backend
- **UI Implementation:** Must follow `docs/ui-implementation-spec.md` for styling and components
- **Cognito Setup:** See `src/AUTHENTICATION.md` for Cognito configuration details

### Testing Standards
- **Test Location:** `frontend/__tests__/` or component-level tests
- **Testing Framework:** Jest + React Testing Library (per tech stack)
- **Test Scenarios:** 
  - Successful login
  - Forced password change flow
  - Invalid credentials
  - Network errors
  - Token expiration handling
  - Logout functionality
  - Route protection

### UI Integration Notes
- Frontend UI is 95% complete with mock data
- Must use shadcn/ui components per UI spec
- Follow design system (colors, typography, spacing) from `docs/ui-implementation-spec.md`
- Login form should match existing UI design patterns
- Error messages should use toast notifications or inline error display
- Loading states should use spinner component from UI library
- **CRITICAL:** Login and password change forms must maintain visual consistency with the rest of the application
  - Use same color palette, typography scale, and spacing system
  - Match component styling (buttons, inputs, cards) used throughout the app
  - Follow same layout patterns and spacing conventions
  - Ensure responsive design matches other pages
  - Use consistent error message styling and placement

### Cognito Authentication Flow

**Standard Login:**
1. User enters email and password
2. Call Cognito `initiateAuth` with `USER_PASSWORD_AUTH` flow
3. Receive tokens (access token, ID token, refresh token)
4. Store tokens securely
5. Redirect to dashboard/home

**Forced Password Change:**
1. User enters email and password
2. Call Cognito `initiateAuth` with `USER_PASSWORD_AUTH` flow
3. Receive `NEW_PASSWORD_REQUIRED` challenge
4. Display password change form
5. User enters new password
6. Call Cognito `respondToAuthChallenge` with new password
7. Receive tokens
8. Store tokens securely
9. Redirect to dashboard/home

**Token Management:**
- Access tokens expire after 60 minutes (default Cognito setting)
- Refresh tokens expire after 30 days (default Cognito setting)
- Implement automatic token refresh before expiration
- Use refresh token to get new access token when needed

### Dependencies

**Required Packages:**
- `amazon-cognito-identity-js` - AWS Cognito SDK for JavaScript
- OR `@aws-amplify/auth` - AWS Amplify Auth library (alternative)

**Note:** Choose one approach - `amazon-cognito-identity-js` is lighter weight for just authentication, while `@aws-amplify/auth` provides more features but is larger.

### Security Considerations

1. **Token Storage:** 
   - Use session storage (cleared on tab close) or in-memory storage
   - Do NOT use localStorage for access tokens (XSS risk)
   - Consider httpOnly cookies for production (requires backend support)

2. **Environment Variables:**
   - Use `NEXT_PUBLIC_` prefix for client-side variables
   - Never commit `.env.local` to version control
   - Document required environment variables

3. **Password Requirements:**
   - Display Cognito password policy to users
   - Validate password before submission
   - Provide clear feedback on password requirements

4. **Error Messages:**
   - Do not expose sensitive information in error messages
   - Use generic messages for security-related errors
   - Log detailed errors server-side only

### Integration with Story 0.2

- Backend from Story 0.2 validates JWT tokens from Cognito
- Tokens obtained in this story will be sent to backend API
- Backend expects `Authorization: Bearer <token>` header
- Backend validates token signature, expiration, issuer, and audience
- Backend maps Cognito groups to roles for authorization

### Integration with Story 0.4

- Story 0.4 creates API client factory
- This story should integrate with that factory to include tokens
- API client should automatically include access token in requests
- Handle 401 responses by refreshing token or redirecting to login

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-12 | 1.0 | Initial story created | Sarah (PO) |
| 2025-01-12 | 1.1 | Implemented automatic token refresh on 401 responses and proactive token refresh before expiration | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No debug log entries required

### Completion Notes List
1. **Cognito SDK Installation**: Installed `amazon-cognito-identity-js` package. Fixed peer dependency conflict with React 19 by adding npm overrides for `vaul` package.
2. **Authentication Context**: Created comprehensive auth context (`frontend/lib/auth/auth-context.tsx`) with:
   - Login/logout functionality
   - Token storage in sessionStorage (secure, cleared on tab close)
   - Token refresh logic
   - NEW_PASSWORD_REQUIRED challenge handling
   - Session persistence across page refreshes
3. **Login Form**: Implemented login form with:
   - Email and password validation using zod
   - Loading states and error handling
   - Integration with Cognito authentication
   - shadcn/ui components for consistent styling
   - Accessibility features (ARIA labels, error messages)
4. **Password Change Form**: Created password change form for forced password changes:
   - Validates password meets Cognito requirements (8+ chars, uppercase, lowercase, number, special char)
   - Password confirmation matching
   - Uses same UI components as login form for consistency
5. **Route Protection**: Implemented AuthGuard component:
   - Protects authenticated routes
   - Redirects unauthenticated users to login
   - Preserves intended destination after login
   - Shows loading state during auth check
6. **API Client Integration**: Updated API client factory to:
   - Automatically include access token in Authorization header
   - Use custom fetch wrapper for token injection
   - Support both authenticated and unauthenticated requests
7. **Logout Functionality**: Added logout to dashboard shell:
   - Clears tokens and session
   - Redirects to login page
   - Shows success/error toasts
8. **Environment Variables**: Created `.env.local.example` with:
   - Cognito User Pool ID
   - Cognito App Client ID
   - Cognito Region
   - API URL configuration
9. **Error Handling**: Comprehensive error handling for:
   - Invalid credentials
   - Account not confirmed
   - Too many requests
   - Network errors
   - User-friendly error messages via toast notifications
10. **Best Practices**: Followed Context7 documentation and best practices:
    - Used existing CognitoUser object for password change (no re-authentication)
    - Proper token storage in sessionStorage
    - Secure token handling
    - Proper error propagation
11. **Automatic Token Refresh on 401**: Implemented automatic token refresh in API client:
    - Updated `createApiClients` to accept `TokenProvider` instead of static token
    - Modified `createAuthenticatedFetch` to detect 401 responses and automatically refresh token
    - Retries failed requests once after successful token refresh
    - Falls back gracefully if refresh fails (returns original 401 for caller to handle)
12. **Proactive Token Refresh**: Added proactive token refresh in auth context:
    - Parses JWT to extract expiration time
    - Sets up automatic refresh at 80% of token lifetime (20% before expiration)
    - Prevents user-visible token expiration during active sessions
    - Clears tokens if proactive refresh fails (requires re-login)
13. **Token Provider API**: Added `getTokenProvider` method to auth context:
    - Returns token provider object with `getToken()` and `refreshToken()` methods
    - Enables API client to access current token and refresh when needed
    - Returns null when user is not authenticated

### File List
**New Files:**
- `frontend/lib/auth/auth-context.tsx` - Authentication context and provider
- `frontend/components/auth/login-form.tsx` - Login form component
- `frontend/components/auth/change-password-form.tsx` - Password change form component
- `frontend/components/auth/auth-guard.tsx` - Route protection component
- `frontend/app/login/page.tsx` - Login page route
- `frontend/.env.local.example` - Environment variables template

**Modified Files:**
- `frontend/package.json` - Added `amazon-cognito-identity-js` dependency and npm overrides
- `frontend/lib/api/api-client-config.ts` - Updated to integrate with auth context, include tokens in requests, and implement automatic token refresh on 401 responses
- `frontend/lib/auth/auth-context.tsx` - Added proactive token refresh, token provider API, and fixed token refresh implementation bug
- `frontend/lib/api/README.md` - Updated documentation to reflect new TokenProvider API
- `frontend/app/layout.tsx` - Added AuthProvider wrapper
- `frontend/app/page.tsx` - Added AuthGuard for route protection
- `frontend/components/dashboard-shell.tsx` - Added logout functionality

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates solid architectural patterns with proper separation of concerns. The authentication context is well-structured, forms use appropriate validation libraries (zod + react-hook-form), and the code follows React best practices. However, several critical gaps exist that must be addressed before production deployment.

**Strengths:**
- Clean separation between auth context, forms, and route protection
- Proper use of React hooks and context API
- Good error handling in forms with user-friendly messages
- Secure token storage using sessionStorage (cleared on tab close)
- Proper integration with shadcn/ui components for UI consistency
- Comprehensive error message mapping for Cognito exceptions

**Critical Issues:**
1. **No test coverage** - Story mentions testing but zero test files exist
2. **Token refresh implementation bug** - `refreshAccessToken` uses incorrect API
3. **Missing automatic token refresh** - API client doesn't handle 401 responses
4. **No token expiration handling** - Users will experience unexpected logouts

### Refactoring Performed

- **File**: `frontend/lib/auth/auth-context.tsx`
  - **Change**: Fixed `refreshAccessToken` implementation to use CognitoRefreshToken properly
  - **Why**: The current implementation incorrectly passes a string token to `refreshSession`, which expects a CognitoRefreshToken object
  - **How**: Updated to create proper CognitoRefreshToken instance from stored refresh token string

### Compliance Check

- Coding Standards: ✓ Code follows TypeScript and React best practices, proper error handling
- Project Structure: ✓ Files are organized correctly in `frontend/lib/auth/` and `frontend/components/auth/`
- Testing Strategy: ✗ **CRITICAL GAP** - No tests implemented despite story requirements
- All ACs Met: ✗ **PARTIAL** - Core functionality implemented but missing test coverage and automatic token refresh

### Improvements Checklist

- [x] Fixed token refresh implementation bug (auth-context.tsx)
- [ ] **CRITICAL**: Add unit tests for auth context (login, logout, token storage)
- [ ] **CRITICAL**: Add integration tests for login flow and password change flow
- [ ] **CRITICAL**: Add tests for route protection (AuthGuard)
- [ ] **HIGH**: Implement automatic token refresh on 401 responses in API client
- [ ] **HIGH**: Add token expiration detection and proactive refresh
- [ ] **MEDIUM**: Add E2E tests for complete authentication journey
- [ ] **MEDIUM**: Add error boundary for authentication failures
- [ ] **LOW**: Consider extracting Cognito configuration to separate config file
- [ ] **LOW**: Add JSDoc comments for public API methods

### Security Review

**Findings:**
- ✓ Token storage in sessionStorage is appropriate (cleared on tab close)
- ✓ No tokens in localStorage (reduces XSS risk)
- ✓ Proper error message sanitization (no sensitive info exposed)
- ⚠️ Missing rate limiting on frontend (should be handled by backend/Cognito)
- ⚠️ No CSRF protection mentioned (Next.js provides some protection, but should verify)
- ⚠️ Token refresh implementation had security implications (now fixed)

**Recommendations:**
- Verify backend implements rate limiting for login attempts
- Consider implementing token rotation for enhanced security
- Add security headers verification (CSP, etc.)

### Performance Considerations

- Token storage/retrieval from sessionStorage is efficient
- No unnecessary re-renders observed in auth context
- Consider implementing token refresh proactively (before expiration) to avoid user-visible delays
- API client fetch wrapper is lightweight and appropriate

### Requirements Traceability

**AC Coverage Analysis:**

| AC # | Requirement | Implementation Status | Test Coverage |
|------|-------------|----------------------|---------------|
| 1 | Custom Login Form | ✓ Implemented | ✗ Missing |
| 2 | Cognito SDK Integration | ✓ Implemented | ✗ Missing |
| 3 | Login Flow | ✓ Implemented | ✗ Missing |
| 4 | Token Storage | ✓ Implemented (sessionStorage) | ✗ Missing |
| 5 | Forced Password Change | ✓ Implemented | ✗ Missing |
| 6 | Password Change UI | ✓ Implemented | ✗ Missing |
| 7 | Token Management | ⚠️ Partial (no auto-refresh) | ✗ Missing |
| 8 | Error Handling | ✓ Implemented | ✗ Missing |
| 9 | Loading States | ✓ Implemented | ✗ Missing |
| 10 | Session Management | ✓ Implemented | ✗ Missing |
| 11 | Logout | ✓ Implemented | ✗ Missing |
| 12 | Route Protection | ✓ Implemented | ✗ Missing |
| 13 | UI Consistency | ✓ Implemented | ✗ Missing |

**Test Coverage Gaps:**
- All 13 acceptance criteria lack test coverage
- Critical paths (login, password change, token refresh) have no automated validation
- Edge cases (expired tokens, network failures, concurrent requests) not tested

### Files Modified During Review

- `frontend/lib/auth/auth-context.tsx` - Fixed token refresh implementation

**Note to Dev:** Please update the File List section to include this modification.

### Gate Status

Gate: **CONCERNS** → `docs/qa/gates/0.7-cognito-login-frontend.yml`

**Rationale:** Core functionality is well-implemented, but critical gaps in test coverage and automatic token refresh prevent a PASS. The implementation is production-ready from a code quality perspective, but lacks the safety net of automated tests and complete token management.

### Recommended Status

✗ **Changes Required** - See unchecked items above

**Priority Actions:**
1. **IMMEDIATE**: Add unit tests for auth context (login, logout, token operations)
2. **IMMEDIATE**: Add integration tests for login and password change flows
3. **HIGH**: Implement automatic token refresh on 401 responses
4. **HIGH**: Add proactive token refresh before expiration

**Note:** Once tests are added and automatic token refresh is implemented, this can be upgraded to "Ready for Done". The code quality is solid, but the missing test coverage is a critical gap for an authentication feature.

