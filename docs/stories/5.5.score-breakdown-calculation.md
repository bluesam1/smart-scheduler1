# Story 5.5: Score Breakdown Calculation

## Status
Approved

## Story

**As a** dispatcher,
**I want** to see a breakdown of how each recommendation score was calculated,
**so that** I can understand why contractors were ranked as they were.

## Acceptance Criteria

1. **Breakdown Structure:** ScoreBreakdown includes availability, rating, distance, optional rotation
2. **Per-Factor Scores:** Each factor score calculated and included
3. **Score Range:** All factor scores in 0-100 range
4. **Breakdown DTO:** ScoreBreakdown DTO matches API specification
5. **Included in Response:** Breakdown included in recommendation response
6. **Consistency:** Breakdown matches final score calculation
7. **Optional Fields:** Rotation score optional (only if rotation applied)
8. **Performance:** Breakdown calculation doesn't impact performance
9. **Testing:** Comprehensive tests
10. **Documentation:** Breakdown structure documented

## Tasks / Subtasks

- [x] Create ScoreBreakdown DTO
  - [x] Create `ScoreBreakdown` class
  - [x] Include all factor scores
  - [x] Make rotation optional
- [x] Calculate availability score
  - [x] Calculate in scoring service
  - [x] Normalize to 0-100
  - [x] Include in breakdown
- [x] Calculate rating score
  - [x] Use contractor rating (0-100)
  - [x] Include in breakdown
- [x] Calculate distance score
  - [x] Normalize distance to 0-100
  - [x] Include in breakdown
- [x] Calculate rotation score (optional)
  - [x] Calculate if rotation applied
  - [x] Include in breakdown if present
- [ ] Include in recommendation
  - [ ] Add breakdown to Recommendation DTO
  - [ ] Include in API response
- [x] Add unit tests
  - [x] Test breakdown calculation
  - [x] Test score consistency
  - [x] Test optional rotation
- [x] Verify API spec compliance
  - [x] Ensure breakdown matches API spec
  - [x] Verify all required fields

## Dev Notes

### Relevant Source Tree Info
- Score breakdown: `src/SmartScheduler.Application/DTOs/ScoreBreakdown.cs`
- Calculation: In scoring service

### Architecture References
- **Score Breakdown:** See `docs/architecture/data-models.md` for ScoreBreakdown model
- **API Specification:** See `docs/architecture/api-specification.md` for breakdown structure

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Breakdown Tests:** Test calculation, consistency, optional fields

### UI Integration Notes
- Breakdown displayed in recommendation cards
- Frontend shows score breakdown in UI
- UI components already exist
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- ScoreBreakdown DTO already created in Story 5.2 (src/SmartScheduler.Application/DTOs/ScoreBreakdown.cs)
- Breakdown includes: Availability (0-100), Rating (0-100), Distance (0-100), Rotation (optional, 0-100)
- All factor scores calculated and included in ScoreResult from ScoringService
- Breakdown is consistent with final score calculation
- Rotation score is optional (only included when rotation boost is applied)
- All scores normalized to 0-100 range
- Tests already cover breakdown calculation in ScoringServiceTests
- Breakdown will be included in Recommendation DTO when recommendations API is implemented (Story 6.1)

### File List
- src/SmartScheduler.Application/DTOs/ScoreBreakdown.cs (created in Story 5.2)
- src/SmartScheduler.Application/Recommendations/Services/ScoringService.cs (includes breakdown calculation)
- src/SmartScheduler.Application.Tests/Recommendations/Services/ScoringServiceTests.cs (tests breakdown)

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall:** ScoreBreakdown DTO is properly structured and well-integrated with scoring service. All factor scores are correctly calculated and included. Optional rotation field is properly implemented.

**Strengths:**
- Clean DTO structure with all required fields
- Optional rotation field correctly implemented (nullable)
- All scores normalized to 0-100 range
- Breakdown is consistent with final score calculation
- Well-documented with XML comments

**Integration:**
- Breakdown calculated as part of scoring process (no additional overhead)
- Included in ScoreResult for easy access
- Ready for inclusion in Recommendation DTO (Story 6.1)

### Refactoring Performed

None required. DTO structure is correct and well-designed.

### Compliance Check

- Coding Standards: ✓ Follows C# conventions
- Project Structure: ✓ Correct placement in Application/DTOs
- Testing Strategy: ✓ Covered by ScoringServiceTests
- All ACs Met: ✓ All critical ACs met. AC 5 (included in response) deferred to Story 6.1

### Requirements Traceability

**AC 1 - Breakdown Structure:** ✓ Includes Availability, Rating, Distance, optional Rotation
**AC 2 - Per-Factor Scores:** ✓ All factor scores calculated and included
**AC 3 - Score Range:** ✓ All scores in 0-100 range (verified in tests)
**AC 4 - Breakdown DTO:** ✓ ScoreBreakdown matches API specification
**AC 5 - Included in Response:** ⚠ Deferred to Story 6.1 (recommendations API)
**AC 6 - Consistency:** ✓ Breakdown matches final score calculation
**AC 7 - Optional Fields:** ✓ Rotation is optional (nullable double?)
**AC 8 - Performance:** ✓ No performance impact (calculated as part of scoring)
**AC 9 - Testing:** ✓ Covered by ScoringServiceTests (10 tests)
**AC 10 - Documentation:** ✓ Well-documented with XML comments

### Test Coverage Analysis

**Coverage:** Covered by ScoringServiceTests (10 tests) which verify:
- Breakdown calculation
- Score consistency
- Optional rotation field
- All scores in 0-100 range

**Test Quality:** Excellent - breakdown is thoroughly tested as part of scoring tests.

### Security Review

**Status:** PASS
- No security concerns

### Performance Considerations

**Status:** PASS
- Breakdown calculated as part of scoring - no additional overhead
- No performance impact

### Files Modified During Review

None - DTO structure is correct.

### Gate Status

Gate: **PASS** → `docs/qa/gates/5.5-score-breakdown-calculation.yml`

### Recommended Status

✓ **Ready for Done** - ScoreBreakdown DTO is properly implemented and ready for API integration in Story 6.1.

