# Story 0.2: Authentication & Cognito Integration

## Status
Ready for Review

## Story

**As a** dispatcher or contractor,
**I want** to authenticate using Amazon Cognito,
**so that** I can securely access the SmartScheduler system with proper role-based authorization.

## Acceptance Criteria

1. **Cognito Configuration:** Amazon Cognito User Pool configured with OIDC/OAuth2
2. **JWT Validation:** Backend validates JWT tokens from Cognito
3. **Role-Based Authorization:** System recognizes roles (Admin, Dispatcher, Contractor) from JWT `groups` claim
4. **Authorization Policies:** Policy-based authorization configured for different roles
5. **Protected Endpoints:** All API endpoints require valid JWT authentication
6. **Frontend Integration:** Frontend can authenticate and receive access tokens
7. **Token Refresh:** Token refresh mechanism configured
8. **Error Handling:** Proper 401/403 responses for authentication/authorization failures
9. **Health Check Exception:** `/health` endpoint remains public (no auth required)
10. **Security:** Tokens validated for signature, expiration, and issuer

## Tasks / Subtasks

- [x] Configure Amazon Cognito
  - [x] Set up Cognito User Pool (documented setup steps)
  - [x] Configure OIDC/OAuth2 settings (documented in AUTHENTICATION.md)
  - [x] Create user groups (Admin, Dispatcher, Contractor) - documented setup
  - [x] Configure hosted UI (for frontend) - documented setup
- [x] Implement JWT validation
  - [x] Install JWT authentication packages (Microsoft.AspNetCore.Authentication.JwtBearer, System.IdentityModel.Tokens.Jwt)
  - [x] Configure JWT bearer authentication (AuthenticationExtensions.cs)
  - [x] Validate token signature against Cognito public keys (automatic via Authority)
  - [x] Validate token expiration and issuer (TokenValidationParameters configured)
- [x] Set up authorization policies
  - [x] Create policy for Admin role
  - [x] Create policy for Dispatcher role
  - [x] Create policy for Contractor role
  - [x] Configure policy-based authorization (AddRoleBasedAuthorization)
- [x] Protect API endpoints
  - [x] Apply `[Authorize]` attribute to all endpoints except `/health`
  - [x] Apply role-based policies to appropriate endpoints (test endpoints created)
- [x] Configure CORS with credentials
  - [x] Allow credentials for authenticated requests (AllowCredentials() configured)
  - [x] Configure allowed origins (frontend URL) (localhost:3000 configured)
- [x] Document authentication flow
  - [x] Document Cognito setup steps (AUTHENTICATION.md)
  - [x] Document frontend integration approach (AUTHENTICATION.md)
  - [x] Document token refresh process (AUTHENTICATION.md)

## Dev Notes

### Relevant Source Tree Info
- Authentication configuration: `src/SmartScheduler.Api/Program.cs` or `Startup.cs`
- Authorization policies: `src/SmartScheduler.Api/Policies/`
- JWT configuration: `src/SmartScheduler.Api/appsettings.json` (Cognito settings)

### Architecture References
- **Authentication:** Amazon Cognito (User Pool + Hosted UI) - see `docs/architecture/tech-stack.md`
- **Security:** See `docs/prd/security-privacy.md` for security requirements
- **API Specification:** See `docs/architecture/api-specification.md` for authentication requirements

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/`
- **Auth Tests:** Unit tests for JWT validation, integration tests for protected endpoints
- **Test Scenarios:** Valid token, expired token, invalid signature, missing token, wrong role

### UI Integration Notes
- Frontend already has authentication UI components (needs to be connected)
- Frontend expects to receive JWT tokens from Cognito
- Frontend will send tokens in `Authorization: Bearer <token>` header
- Token refresh should be handled by frontend with backend support

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |
| 2025-11-12 | 1.1 | Story completed - All tasks implemented, tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used
Auto (Claude Sonnet 4.5)

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes List
- Implemented JWT authentication with Amazon Cognito integration
- Created AuthenticationExtensions class with AddCognitoAuthentication and AddRoleBasedAuthorization methods
- Configured JWT bearer authentication with automatic token validation against Cognito public keys
- Set up three authorization policies: Admin, Dispatcher, and Contractor
- Protected all API endpoints except `/health` (which remains public)
- Configured CORS with credentials support for authenticated requests
- Created comprehensive test suite with 13 tests covering all authorization scenarios
- All tests passing: role-based access, unauthorized access, health check public access
- Added Cognito configuration to appsettings.json (with placeholder values)
- Created comprehensive AUTHENTICATION.md documentation with setup instructions
- Token validation includes signature, expiration, issuer, and audience validation
- Cognito groups claim automatically mapped to ASP.NET Core roles
- SignalR token support configured (for future Story 0.3)

### File List
**Created Files:**
- `src/SmartScheduler.Api/Authentication/AuthenticationExtensions.cs` - Authentication and authorization configuration
- `src/SmartScheduler.Api.Tests/Authorization/AuthorizationPolicyTests.cs` - Authorization policy integration tests
- `src/SmartScheduler.Api.Tests/Utilities/TestJwtTokenGenerator.cs` - JWT token generator utility for tests
- `src/AUTHENTICATION.md` - Comprehensive authentication setup and integration documentation

**Modified Files:**
- `src/SmartScheduler.Api/Program.cs` - Added authentication and authorization middleware, protected endpoints
- `src/SmartScheduler.Api/appsettings.json` - Added Cognito configuration section
- `src/SmartScheduler.Api/SmartScheduler.Api.csproj` - Added JWT authentication packages
- `src/SmartScheduler.Api.Tests/SmartScheduler.Api.Tests.csproj` - Added System.IdentityModel.Tokens.Jwt package

## QA Results
_To be populated by QA agent_

