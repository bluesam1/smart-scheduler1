# Story 0.2: Authentication & Cognito Integration

## Status
Approved

## Story

**As a** dispatcher or contractor,
**I want** to authenticate using Amazon Cognito,
**so that** I can securely access the SmartScheduler system with proper role-based authorization.

## Acceptance Criteria

1. **Cognito Configuration:** Amazon Cognito User Pool configured with OIDC/OAuth2
2. **JWT Validation:** Backend validates JWT tokens from Cognito
3. **Role-Based Authorization:** System recognizes roles (Admin, Dispatcher, Contractor) from JWT `groups` claim
4. **Authorization Policies:** Policy-based authorization configured for different roles
5. **Protected Endpoints:** All API endpoints require valid JWT authentication
6. **Frontend Integration:** Frontend can authenticate and receive access tokens
7. **Token Refresh:** Token refresh mechanism configured
8. **Error Handling:** Proper 401/403 responses for authentication/authorization failures
9. **Health Check Exception:** `/health` endpoint remains public (no auth required)
10. **Security:** Tokens validated for signature, expiration, and issuer

## Tasks / Subtasks

- [ ] Configure Amazon Cognito
  - [ ] Set up Cognito User Pool
  - [ ] Configure OIDC/OAuth2 settings
  - [ ] Create user groups (Admin, Dispatcher, Contractor)
  - [ ] Configure hosted UI (for frontend)
- [ ] Implement JWT validation
  - [ ] Install JWT authentication packages
  - [ ] Configure JWT bearer authentication
  - [ ] Validate token signature against Cognito public keys
  - [ ] Validate token expiration and issuer
- [ ] Set up authorization policies
  - [ ] Create policy for Admin role
  - [ ] Create policy for Dispatcher role
  - [ ] Create policy for Contractor role
  - [ ] Configure policy-based authorization
- [ ] Protect API endpoints
  - [ ] Apply `[Authorize]` attribute to all endpoints except `/health`
  - [ ] Apply role-based policies to appropriate endpoints
- [ ] Configure CORS with credentials
  - [ ] Allow credentials for authenticated requests
  - [ ] Configure allowed origins (frontend URL)
- [ ] Document authentication flow
  - [ ] Document Cognito setup steps
  - [ ] Document frontend integration approach
  - [ ] Document token refresh process

## Dev Notes

### Relevant Source Tree Info
- Authentication configuration: `src/SmartScheduler.Api/Program.cs` or `Startup.cs`
- Authorization policies: `src/SmartScheduler.Api/Policies/`
- JWT configuration: `src/SmartScheduler.Api/appsettings.json` (Cognito settings)

### Architecture References
- **Authentication:** Amazon Cognito (User Pool + Hosted UI) - see `docs/architecture/tech-stack.md`
- **Security:** See `docs/prd/security-privacy.md` for security requirements
- **API Specification:** See `docs/architecture/api-specification.md` for authentication requirements

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/`
- **Auth Tests:** Unit tests for JWT validation, integration tests for protected endpoints
- **Test Scenarios:** Valid token, expired token, invalid signature, missing token, wrong role

### UI Integration Notes
- Frontend already has authentication UI components (needs to be connected)
- Frontend expects to receive JWT tokens from Cognito
- Frontend will send tokens in `Authorization: Bearer <token>` header
- Token refresh should be handled by frontend with backend support

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

