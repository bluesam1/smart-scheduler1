# Story 2.2: Job CRUD API

## Status
Approved

## Story

**As a** dispatcher,
**I want** to create, read, update jobs via REST API,
**so that** I can manage jobs in the system.

## Acceptance Criteria

1. **GET /jobs:** List all jobs with optional status/priority filtering
2. **GET /jobs/{id}:** Get job by ID with full details
3. **POST /jobs:** Create new job with address validation and timezone lookup
4. **PUT /jobs/{id}:** Update existing job
5. **Address Validation:** Google Places API integration for address validation
6. **Timezone Lookup:** Derive timezone from job location coordinates
7. **Authorization:** Dispatcher and Admin roles can perform CRUD operations
8. **Validation:** All input validated according to domain rules
9. **Error Handling:** Proper HTTP status codes and error messages
10. **Database Persistence:** Changes persisted to PostgreSQL

## Tasks / Subtasks

- [ ] Create DTOs
  - [ ] Create `JobDto` response DTO with all computed fields
  - [ ] Create `CreateJobRequest` DTO
  - [ ] Create `UpdateJobRequest` DTO
- [ ] Implement MediatR commands/queries
  - [ ] Create `GetJobsQuery` with filtering
  - [ ] Create `GetJobByIdQuery`
  - [ ] Create `CreateJobCommand` with address/timezone processing
  - [ ] Create `UpdateJobCommand`
  - [ ] Create handlers for each
- [ ] Integrate Google Places API
  - [ ] Create `IAddressValidationService` interface
  - [ ] Implement Google Places client
  - [ ] Validate and parse structured address
  - [ ] Cache Place Details by place_id
- [ ] Integrate timezone lookup
  - [ ] Create `ITimezoneService` interface
  - [ ] Implement timezone lookup from lat/long
  - [ ] Cache timezone lookups
- [ ] Implement repository
  - [ ] Implement `JobRepository` in Infrastructure layer
  - [ ] Use EF Core for data access
  - [ ] Implement filtering queries
- [ ] Create API endpoints
  - [ ] `GET /jobs` with `?status=` and `?priority=` params
  - [ ] `GET /jobs/{id}`
  - [ ] `POST /jobs`
  - [ ] `PUT /jobs/{id}`
- [ ] Add authorization and validation
  - [ ] Apply authorization policies
  - [ ] FluentValidation for request DTOs
- [ ] Configure EF Core entities
  - [ ] Create `Job` EF Core entity configuration
  - [ ] Create database migration

## Dev Notes

### Relevant Source Tree Info
- API endpoints: `src/SmartScheduler.Api/Endpoints/Jobs/`
- Commands/Queries: `src/SmartScheduler.Application/Jobs/`
- Address service: `src/SmartScheduler.Infrastructure/Services/AddressValidationService.cs`
- Timezone service: `src/SmartScheduler.Infrastructure/Services/TimezoneService.cs`

### Architecture References
- **API Specification:** See `docs/architecture/api-specification.md`
- **Address Validation:** See `docs/architecture/api-specification.md` section "Address Validation Integration"
- **Google Places:** See `docs/prd/epic-2-job-intake-attributes-windows.md`

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/` and `src/SmartScheduler.Application.Tests/`
- **API Tests:** Integration tests for endpoints
- **Service Tests:** Unit tests for address validation and timezone lookup
- **Mock External APIs:** Mock Google Places and timezone APIs in tests

### UI Integration Notes
- Frontend has `CreateJobDialog` with `AddressInput` component (see `frontend/components/jobs/create-job-dialog.tsx`)
- Frontend has `JobsTable` component (see `frontend/components/jobs/jobs-table.tsx`)
- Frontend expects structured address data
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

