# Story 5.6: Rationale Generation

## Status
Approved

## Story

**As a** dispatcher,
**I want** a human-readable rationale for each recommendation,
**so that** I can quickly understand why a contractor was recommended.

## Acceptance Criteria

1. **Rationale Format:** Deterministic template-based rationale (≤200 chars)
2. **Template System:** Templates for different score scenarios
3. **Factor Highlighting:** Highlights key factors (availability, rating, distance)
4. **Consistency:** Same inputs produce same rationale
5. **Readability:** Human-readable and concise
6. **Included in Response:** Rationale included in recommendation response
7. **Performance:** Rationale generation doesn't impact performance
8. **Testing:** Comprehensive tests
9. **Documentation:** Rationale format documented
10. **Localization:** Support for future localization (optional)

## Tasks / Subtasks

- [x] Design rationale templates
  - [x] Create templates for different scenarios
  - [x] Keep under 200 characters
  - [x] Make human-readable
- [x] Implement rationale generator
  - [x] Create `IRationaleGenerator` interface
  - [x] Implement template selection
  - [x] Fill template with factor values
- [x] Create template scenarios
  - [x] High availability scenario
  - [x] High rating scenario
  - [x] Low distance scenario
  - [x] Balanced scenario
- [x] Generate rationale
  - [x] Select appropriate template
  - [x] Fill in factor values
  - [x] Ensure ≤200 characters
- [ ] Add to recommendation
  - [ ] Include rationale in Recommendation DTO
  - [ ] Include in API response
- [x] Add unit tests
  - [x] Test rationale generation
  - [x] Test template selection
  - [x] Test character limit
  - [x] Test deterministic behavior
- [x] Document rationale format
  - [x] Document templates
  - [x] Document selection logic

## Dev Notes

### Relevant Source Tree Info
- Rationale generator: `src/SmartScheduler.Application/Recommendations/Services/RationaleGenerator.cs`
- Templates: `src/SmartScheduler.Application/Recommendations/Templates/`

### Architecture References
- **Rationale:** See `docs/architecture/data-models.md` for rationale field (≤200 chars)
- **Deterministic:** Same inputs produce same rationale - see PRD
- **Template-Based:** Template system for consistency - see architecture

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Rationale Tests:** Test generation, templates, character limit, deterministic behavior

### UI Integration Notes
- Rationale displayed in recommendation cards
- Frontend shows rationale in UI
- UI components already exist
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Created IRationaleGenerator interface and RationaleGenerator implementation
- Template-based approach for deterministic rationale generation
- Templates selected based on primary factor strength (high ≥80, good ≥60, balanced otherwise)
- Rationale highlights key factors: availability, rating, distance
- Uses descriptive terms: "excellent", "good", "moderate", "limited" for availability
- Uses descriptive terms: "excellent", "strong", "good", "average" for rating
- Uses descriptive terms: "very close", "close", "moderate", "distant" for distance
- All rationales guaranteed ≤200 characters (truncated if needed)
- Deterministic: same inputs produce same rationale
- Registered service in Program.cs
- Created comprehensive unit tests (9 tests, all passing)
- Rationale will be included in Recommendation DTO when recommendations API is implemented (Story 6.1)

### File List
- src/SmartScheduler.Application/Recommendations/Services/IRationaleGenerator.cs (new)
- src/SmartScheduler.Application/Recommendations/Services/RationaleGenerator.cs (new)
- src/SmartScheduler.Application.Tests/Recommendations/Services/RationaleGeneratorTests.cs (new)
- src/SmartScheduler.Api/Program.cs (modified - registered rationale generator service)

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall:** Excellent template-based rationale generator with deterministic output. Template selection logic is sound, character limit is enforced, and all scenarios are well-covered.

**Strengths:**
- Template-based approach ensures consistency and determinism
- Smart template selection based on primary factor strength
- Descriptive helper methods (GetAvailabilityDescription, etc.) improve maintainability
- Character limit enforced with truncation
- Deterministic output verified in tests

**Template Quality:**
- High score templates (≥80): Emphasize primary strength
- Good score templates (≥60): Highlight primary factor
- Balanced templates: Show multiple factors
- Descriptive terms provide good readability

### Refactoring Performed

None required. Implementation is excellent.

### Compliance Check

- Coding Standards: ✓ Follows C# conventions
- Project Structure: ✓ Correct placement in Application layer
- Testing Strategy: ✓ Comprehensive unit tests (9 tests)
- All ACs Met: ✓ All critical ACs met. AC 6 (included in response) deferred to Story 6.1, AC 10 (localization) is future enhancement

### Requirements Traceability

**AC 1 - Rationale Format:** ✓ Deterministic template-based, ≤200 chars
**AC 2 - Template System:** ✓ Multiple templates for different scenarios
**AC 3 - Factor Highlighting:** ✓ Highlights availability, rating, distance
**AC 4 - Consistency:** ✓ Deterministic - same inputs produce same output
**AC 5 - Readability:** ✓ Human-readable with descriptive terms
**AC 6 - Included in Response:** ⚠ Deferred to Story 6.1 (recommendations API)
**AC 7 - Performance:** ✓ O(1) template generation - very efficient
**AC 8 - Testing:** ✓ 9 comprehensive unit tests
**AC 9 - Documentation:** ✓ Well-documented with XML comments
**AC 10 - Localization:** ⚠ Future enhancement (acceptable)

### Test Coverage Analysis

**Coverage:** 9 comprehensive unit tests covering:
- High availability scenario
- High rating scenario
- High distance scenario
- Balanced scores scenario
- Deterministic behavior
- Rotation boost scenarios
- Character limit enforcement
- Low scores handling
- Multiple test cases for character limit validation

**Test Quality:** Excellent - covers all template scenarios and edge cases.

### Security Review

**Status:** PASS
- No security concerns
- No user input directly affects rationale generation

### Performance Considerations

**Status:** PASS
- Template-based generation is O(1) - very efficient
- No external dependencies
- No performance concerns

### Files Modified During Review

None - implementation is excellent.

### Gate Status

Gate: **PASS** → `docs/qa/gates/5.6-rationale-generation.yml`

### Recommended Status

✓ **Ready for Done** - Excellent implementation with comprehensive test coverage. Rationale will be included in Recommendation DTO when API is implemented in Story 6.1.

