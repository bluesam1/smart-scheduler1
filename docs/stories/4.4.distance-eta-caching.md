# Story 4.4: Distance/ETA Caching

## Status
Approved

## Story

**As a** system,
**I want** to cache distance and ETA calculations,
**so that** I can improve performance and reduce API calls to OpenRouteService.

## Acceptance Criteria

1. **Cache Strategy:** Cache distance/ETA results by location pairs
2. **Cache Key:** Efficient cache key generation (lat/long rounded)
3. **Cache TTL:** Appropriate TTL for distance/ETA data
4. **Cache Storage:** Use in-memory cache (IMemoryCache)
5. **Cache Hit Rate:** Monitor cache hit rate
6. **Cache Invalidation:** Handle cache invalidation if needed
7. **Performance:** Cache improves response time
8. **Cost Reduction:** Reduces ORS API calls
9. **Fallback:** Cache miss falls back to API call
10. **Monitoring:** Cache metrics tracked

## Tasks / Subtasks

- [ ] Design cache strategy
  - [ ] Determine cache key format
  - [ ] Determine cache TTL
  - [ ] Determine cache size limits
- [ ] Implement cache key generation
  - [ ] Generate keys from location pairs
  - [ ] Round coordinates for cache efficiency
  - [ ] Handle coordinate precision
- [ ] Implement caching layer
  - [ ] Wrap ORS client with caching
  - [ ] Check cache before API call
  - [ ] Store results in cache
- [ ] Configure cache TTL
  - [ ] Set appropriate TTL for distance/ETA
  - [ ] Consider data freshness requirements
- [ ] Add cache metrics
  - [ ] Track cache hits/misses
  - [ ] Monitor cache performance
- [ ] Handle cache invalidation
  - [ ] Invalidate if needed (rare for distance/ETA)
  - [ ] Handle cache eviction
- [ ] Optimize cache performance
  - [ ] Efficient cache lookups
  - [ ] Minimize cache overhead
- [ ] Create unit tests
  - [ ] Test cache hit/miss behavior
  - [ ] Test cache key generation
  - [ ] Test TTL expiration

## Dev Notes

### Relevant Source Tree Info
- Cache wrapper: `src/SmartScheduler.Infrastructure/Services/CachedDistanceService.cs`
- Cache configuration: Uses IMemoryCache

### Architecture References
- **Caching:** In-memory cache for MVP - see `docs/architecture/high-level-architecture.md`
- **Performance:** Caching improves p95 latency - see `docs/prd/caching-performance.md`
- **Cost Optimization:** Reduces ORS API calls - see PRD

### Testing Standards
- **Test Location:** `src/SmartScheduler.Infrastructure.Tests/`
- **Cache Tests:** Test hit/miss, TTL, key generation
- **Performance Tests:** Verify cache improves performance

### UI Integration Notes
- Caching transparent to UI
- Improves recommendation response time
- UI benefits from faster API responses

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

