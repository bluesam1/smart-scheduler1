# Story 6.1: Recommendations API Backend

## Status
Approved

## Story

**As a** dispatcher,
**I want** to request contractor recommendations for a job via API,
**so that** I can see ranked contractors with suggested time slots.

## Acceptance Criteria

1. **POST /recommendations:** Endpoint accepts jobId and desiredDate, returns ranked recommendations
2. **Ranking Algorithm:** Contractors ranked by weighted score (availability, rating, distance, rotation)
3. **Time Slots:** Up to 3 suggested time slots per contractor (earliest, lowest-travel, highest-confidence)
4. **Performance:** p95 latency < 500ms under baseline load
5. **Audit Trail:** Full audit record persisted (request payload, candidates, scores, config version)
6. **Score Breakdown:** Each recommendation includes per-factor scores and rationale
7. **Coarse-to-Refine:** Uses Haversine for initial filtering, OpenRouteService for top candidates
8. **Caching:** Distance/ETA results cached to improve performance
9. **Error Handling:** Proper error responses for invalid requests
10. **OpenAPI Documentation:** Endpoint fully documented

## Tasks / Subtasks

- [x] Create recommendation DTOs
  - [x] Create `RecommendationRequest` DTO
  - [x] Create `RecommendationResponse` DTO
  - [x] Create `Recommendation` DTO with score breakdown
  - [x] Create `TimeSlot` DTO (reused existing TimeSlotDto)
  - [x] Create `ScoreBreakdown` DTO (reused existing ScoreBreakdown)
- [x] Implement recommendation query
  - [x] Create `GetRecommendationsQuery` with MediatR
  - [x] Create query handler
- [x] Implement availability engine integration
  - [x] Call availability engine to get feasible slots
  - [x] Filter contractors by skills compatibility
- [x] Implement distance/ETA service integration
  - [x] Use Haversine for initial filtering
  - [ ] Use OpenRouteService for top 5-8 candidates (TODO: optimize in 6.4)
  - [x] Cache distance/ETA results (via existing CachedDistanceService)
- [x] Implement scoring algorithm
  - [x] Load scoring weights from configuration
  - [x] Calculate availability score
  - [x] Calculate rating score
  - [x] Calculate distance score (normalized)
  - [x] Apply rotation boost if applicable
  - [x] Calculate final weighted score
- [x] Implement tie-breakers
  - [x] Apply tie-breaker logic (earliest start, lower utilization, shortest travel)
- [x] Generate time slots
  - [x] Generate earliest feasible slot
  - [x] Generate lowest-travel slot
  - [x] Generate highest-confidence slot
  - [x] Limit to 3 slots per contractor
- [x] Implement audit trail
  - [x] Create `AuditRecommendation` entity
  - [x] Persist request payload, candidates, scores, config version
  - [ ] Link to assignment if created (deferred to Story 7.2)
- [x] Create API endpoint
  - [x] `POST /recommendations` endpoint
  - [x] Validate request
  - [x] Return ranked recommendations
- [ ] Performance optimization
  - [ ] Implement caching strategy (deferred to Story 6.4)
  - [ ] Optimize database queries (deferred to Story 6.4)
  - [ ] Profile and optimize hot paths (deferred to Story 6.4)

## Dev Notes

### Relevant Source Tree Info
- API endpoint: `src/SmartScheduler.Api/Endpoints/Recommendations/`
- Query handler: `src/SmartScheduler.Application/Recommendations/Queries/`
- Scoring service: `src/SmartScheduler.Application/Recommendations/Services/ScoringService.cs`
- Audit entity: `src/SmartScheduler.Domain/Recommendations/Entities/AuditRecommendation.cs`

### Architecture References
- **API Specification:** See `docs/architecture/api-specification.md` for `/recommendations` endpoint
- **Scoring Algorithm:** See `docs/prd/epic-5-scoring-ranking-v1-rules.md`
- **Performance:** p95 < 500ms requirement - see `docs/prd/7-non-functional-requirements.md`
- **Coarse-to-Refine:** See `docs/prd/caching-performance.md`

### Testing Standards
- **Test Location:** `src/SmartScheduler.Api.Tests/` and `src/SmartScheduler.Application.Tests/`
- **API Tests:** Integration tests for endpoint, performance tests
- **Scoring Tests:** Unit tests for scoring algorithm, deterministic scores
- **Performance Tests:** Load tests to verify p95 < 500ms

### UI Integration Notes
- Frontend has `RecommendationsSheet` component (see `frontend/components/jobs/recommendations-sheet.tsx`)
- Frontend currently uses mock data with `generateRecommendations` function
- Frontend expects recommendations with score breakdown and time slots
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Created all recommendation DTOs (RecommendationRequest, RecommendationResponse, RecommendationDto)
- Reused existing TimeSlotDto and ScoreBreakdown DTOs
- Implemented GetRecommendationsQuery with comprehensive handler that:
  - Gets job and filters contractors by skills
  - Uses AvailabilityEngine to get feasible slots
  - Calculates distance using Haversine (ORS optimization deferred to 6.4)
  - Calculates scores using ScoringService with weights from config
  - Generates time slots using SlotGenerator (earliest, lowest-travel, highest-confidence)
  - Applies tie-breaker logic using TieBreakerService
  - Generates rationale using RationaleGenerator
  - Persists audit trail asynchronously (fire-and-forget)
- Created AuditRecommendation entity with repository and EF Core configuration
- Created POST /api/recommendations endpoint with validation and error handling
- Registered all required services (domain services, repositories, application services)
- Note: Coarse-to-refine strategy (ORS for top candidates) partially implemented - using Haversine for all. Optimization deferred to Story 6.4.
- Note: Performance optimization tasks deferred to Story 6.4 as planned
- Note: Assignment linking in audit trail deferred to Story 7.2

### File List
- src/SmartScheduler.Application/Recommendations/DTOs/RecommendationRequest.cs (new)
- src/SmartScheduler.Application/Recommendations/DTOs/RecommendationResponse.cs (new)
- src/SmartScheduler.Application/Recommendations/DTOs/RecommendationDto.cs (new)
- src/SmartScheduler.Application/Recommendations/Queries/GetRecommendationsQuery.cs (new)
- src/SmartScheduler.Application/Recommendations/Handlers/GetRecommendationsQueryHandler.cs (new)
- src/SmartScheduler.Domain/Contracts/Entities/AuditRecommendation.cs (new)
- src/SmartScheduler.Domain/Contracts/Repositories/IAuditRecommendationRepository.cs (new)
- src/SmartScheduler.Infrastructure/Contracts/Repositories/AuditRecommendationRepository.cs (new)
- src/SmartScheduler.Infrastructure/Data/SmartSchedulerDbContext.cs (modified - added AuditRecommendation DbSet and configuration)
- src/SmartScheduler.Api/Endpoints/Recommendations/RecommendationEndpoints.cs (new)
- src/SmartScheduler.Api/Program.cs (modified - registered audit repository, domain services, and recommendation endpoints)

## QA Results
_To be populated by QA agent_

