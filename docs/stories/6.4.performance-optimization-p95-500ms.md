# Story 6.4: Performance Optimization (p95 < 500ms)

## Status
Approved

## Story

**As a** system,
**I want** the recommendations API to achieve p95 latency < 500ms,
**so that** dispatchers get fast responses when requesting recommendations.

## Acceptance Criteria

1. **Performance Target:** p95 latency < 500ms under baseline load
2. **Profiling:** Performance bottlenecks identified
3. **Optimization:** Critical paths optimized
4. **Caching:** Aggressive caching where appropriate
5. **Database Optimization:** Database queries optimized
6. **Parallel Processing:** Parallel processing where possible
7. **Load Testing:** Load tests verify p95 < 500ms
8. **Monitoring:** Performance metrics tracked
9. **Documentation:** Optimization strategies documented
10. **Continuous Monitoring:** Performance monitored in production

## Tasks / Subtasks

- [ ] Profile recommendations flow
  - [ ] Identify bottlenecks
  - [ ] Measure each step
  - [ ] Document findings
- [ ] Optimize database queries
  - [ ] Optimize contractor queries
  - [ ] Optimize availability queries
  - [ ] Add indexes if needed
  - [ ] Use efficient joins
- [ ] Optimize distance calculations
  - [ ] Use Haversine for initial filtering
  - [ ] Limit ORS calls to top candidates
  - [ ] Cache distance/ETA results
- [ ] Optimize availability calculation
  - [ ] Cache availability windows
  - [ ] Optimize slot generation
  - [ ] Parallel processing where possible
- [ ] Optimize scoring
  - [ ] Efficient scoring algorithm
  - [ ] Cache scoring results if applicable
- [ ] Add performance monitoring
  - [ ] Track recommendation latency
  - [ ] Track p95/p99 metrics
  - [ ] Alert on performance degradation
- [ ] Conduct load testing
  - [ ] Create load test scenarios
  - [ ] Verify p95 < 500ms
  - [ ] Document results
- [ ] Document optimizations
  - [ ] Document optimization strategies
  - [ ] Document performance targets
  - [ ] Document monitoring approach

## Dev Notes

### Relevant Source Tree Info
- Performance monitoring: `src/SmartScheduler.Api/Middleware/PerformanceMiddleware.cs`
- Optimization: Throughout recommendations flow

### Architecture References
- **Performance Target:** p95 < 500ms - see `docs/prd/7-non-functional-requirements.md`
- **Coarse-to-Refine:** See `docs/prd/caching-performance.md`
- **Caching:** In-memory cache for MVP - see architecture

### Testing Standards
- **Test Location:** Performance tests in `tests/`
- **Load Tests:** Load tests to verify p95 < 500ms
- **Profiling:** Performance profiling during development

### UI Integration Notes
- Performance improvements benefit UI responsiveness
- Faster API = better user experience
- UI shows loading states during API calls

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

