# Story 0.3: SignalR Real-time Setup

## Status
Approved

## Story

**As a** dispatcher or contractor,
**I want** real-time updates via SignalR,
**so that** I see changes immediately without manual page refreshes.

## Acceptance Criteria

1. **SignalR Hub:** SignalR hub created and configured
2. **Connection Groups:** Groups configured for dispatchers (`/dispatch/{region}`) and contractors (`/contractor/{id}`)
3. **Connection Management:** Clients can connect and join appropriate groups
4. **Event Publishing:** Infrastructure for publishing events to SignalR groups
5. **Frontend Integration:** Frontend can connect to SignalR hub
6. **Connection State:** Connection state management and reconnection handling
7. **Error Handling:** Graceful handling of connection failures
8. **Health Check:** SignalR connection health can be verified
9. **CORS Configuration:** SignalR CORS configured for frontend origin
10. **Authentication:** SignalR connections require valid JWT authentication

## Tasks / Subtasks

- [ ] Create SignalR hub
  - [ ] Create `RecommendationsHub` in `src/SmartScheduler.Realtime/`
  - [ ] Configure hub routes
  - [ ] Set up connection groups
- [ ] Implement group management
  - [ ] Method to add dispatcher to region group
  - [ ] Method to add contractor to personal group
  - [ ] Handle disconnection and group removal
- [ ] Create event publishing service
  - [ ] Create `IRealtimePublisher` interface
  - [ ] Implement SignalR publisher
  - [ ] Methods for `RecommendationReady` and `JobAssigned` events
- [ ] Configure SignalR in API
  - [ ] Register SignalR services
  - [ ] Map hub endpoints
  - [ ] Configure CORS for SignalR
  - [ ] Configure authentication for SignalR
- [ ] Document SignalR events
  - [ ] Document `RecommendationReady` event structure
  - [ ] Document `JobAssigned` event structure
  - [ ] Document connection flow

## Dev Notes

### Relevant Source Tree Info
- SignalR hub: `src/SmartScheduler.Realtime/Hubs/RecommendationsHub.cs`
- Realtime publisher: `src/SmartScheduler.Realtime/Services/RealtimePublisher.cs`
- SignalR configuration: `src/SmartScheduler.Api/Program.cs`

### Architecture References
- **Real-time:** SignalR 8.0 - see `docs/architecture/tech-stack.md`
- **SignalR Groups:** See `docs/prd/realtime.md` for group structure
- **Events:** See `docs/prd/domain-events-integrations.md` for event types

### Testing Standards
- **Test Location:** `src/SmartScheduler.Realtime.Tests/`
- **Hub Tests:** Unit tests for hub methods, integration tests for connection flow
- **Test Scenarios:** Connection, group joining, event publishing, disconnection

### UI Integration Notes
- Frontend needs SignalR client connection (not yet implemented)
- Frontend will subscribe to `RecommendationReady` and `JobAssigned` events
- Frontend should handle reconnection automatically
- UI components already exist but use mock data - will be updated to use real-time events

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

