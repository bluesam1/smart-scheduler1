# Story 8.4: Calendar Consistency Checks

## Status
Approved

## Story

**As a** system,
**I want** calendar consistency checks after reschedule/cancel,
**so that** contractor calendars remain consistent and accurate.

## Acceptance Criteria

1. **Consistency Validation:** Calendar consistency validated after changes
2. **Overlap Detection:** Detect overlapping assignments
3. **Gap Detection:** Detect invalid gaps (missing buffers)
4. **Automatic Correction:** Attempt to correct inconsistencies
5. **Error Reporting:** Report inconsistencies that can't be corrected
6. **Performance:** Consistency checks don't significantly impact operations
7. **Integration:** Integrated with reschedule/cancel flows
8. **Monitoring:** Consistency issues tracked
9. **Testing:** Comprehensive tests
10. **Documentation:** Consistency rules documented

## Tasks / Subtasks

- [ ] Create consistency checker
  - [ ] Create `ICalendarConsistencyChecker` interface
  - [ ] Implement consistency validation
- [ ] Implement overlap detection
  - [ ] Check for overlapping assignments
  - [ ] Detect boundary overlaps
  - [ ] Report overlaps
- [ ] Implement gap detection
  - [ ] Check for missing travel buffers
  - [ ] Detect invalid gaps
  - [ ] Report gaps
- [ ] Implement automatic correction
  - [ ] Attempt to fix minor issues
  - [ ] Adjust time slots if possible
  - [ ] Log corrections
- [ ] Add error reporting
  - [ ] Report uncorrectable issues
  - [ ] Include details in errors
  - [ ] Alert administrators
- [ ] Integrate with reschedule/cancel
  - [ ] Run checks after reschedule
  - [ ] Run checks after cancel
  - [ ] Handle check failures
- [ ] Add monitoring
  - [ ] Track consistency issues
  - [ ] Monitor correction rates
- [ ] Add unit tests
  - [ ] Test overlap detection
  - [ ] Test gap detection
  - [ ] Test correction logic

## Dev Notes

### Relevant Source Tree Info
- Consistency checker: `src/SmartScheduler.Application/Scheduling/Services/CalendarConsistencyChecker.cs`
- Integration: Used in reschedule/cancel flows

### Architecture References
- **Calendar Integrity:** See `docs/prd/epic-8-reschedulecancel-calendar-integrity.md`
- **Consistency:** No orphaned overlaps - see PRD
- **Travel Buffers:** Buffer requirements - see Epic 3.3

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/`
- **Consistency Tests:** Test overlap/gap detection, correction logic

### UI Integration Notes
- Consistency checks happen server-side
- UI may show warnings for inconsistencies
- Calendar views show accurate schedules

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

