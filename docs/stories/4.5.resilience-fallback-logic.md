# Story 4.5: Resilience & Fallback Logic

## Status
Approved

## Story

**As a** system,
**I want** resilient distance/ETA calculation with fallback strategies,
**so that** recommendations continue to work even if OpenRouteService is unavailable.

## Acceptance Criteria

1. **Retry Logic:** Retry failed ORS requests with exponential backoff
2. **Circuit Breaker:** Circuit breaker to prevent cascading failures
3. **Timeout Handling:** Handle request timeouts gracefully
4. **Fallback to Haversine:** Fall back to Haversine if ORS unavailable
5. **Degraded Mode:** System continues with reduced accuracy
6. **Error Logging:** Log failures for monitoring
7. **Health Checks:** Monitor ORS API health
8. **Graceful Degradation:** Recommendations work with Haversine-only
9. **Recovery:** Automatic recovery when ORS available again
10. **Documentation:** Resilience strategy documented

## Tasks / Subtasks

- [ ] Configure Polly retry policy
  - [ ] Set up exponential backoff
  - [ ] Configure retry count
  - [ ] Handle specific error types
- [ ] Configure circuit breaker
  - [ ] Set failure threshold
  - [ ] Set circuit open duration
  - [ ] Handle circuit states
- [ ] Implement timeout handling
  - [ ] Set request timeouts
  - [ ] Handle timeout errors
  - [ ] Fall back on timeout
- [ ] Implement fallback to Haversine
  - [ ] Detect ORS unavailability
  - [ ] Switch to Haversine calculation
  - [ ] Log fallback usage
- [ ] Implement degraded mode
  - [ ] Continue with Haversine-only
  - [ ] Mark recommendations as degraded
  - [ ] Still provide recommendations
- [ ] Add health monitoring
  - [ ] Monitor ORS API health
  - [ ] Track failure rates
  - [ ] Alert on persistent failures
- [ ] Implement recovery logic
  - [ ] Detect when ORS available again
  - [ ] Switch back to ORS
  - [ ] Log recovery
- [ ] Add error logging
  - [ ] Log all failures
  - [ ] Include context in logs
  - [ ] Track failure patterns

## Dev Notes

### Relevant Source Tree Info
- Resilience policies: `src/SmartScheduler.Infrastructure/Resilience/`
- Fallback logic: `src/SmartScheduler.Application/Scheduling/Services/DistanceService.cs`

### Architecture References
- **Resilience:** Polly for retry and circuit breaker - see `docs/prd/a-openrouteservice-ors.md`
- **Fallback:** Haversine fallback - see `docs/prd/caching-performance.md`
- **Degraded Mode:** System continues with reduced accuracy - see PRD

### Testing Standards
- **Test Location:** `src/SmartScheduler.Infrastructure.Tests/`
- **Resilience Tests:** Test retry, circuit breaker, timeouts
- **Fallback Tests:** Test Haversine fallback behavior

### UI Integration Notes
- Fallback transparent to UI
- Recommendations may be marked as "estimated" if using Haversine
- UI continues to work in degraded mode

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

