# Story 4.5: Resilience & Fallback Logic

## Status
Approved

## Story

**As a** system,
**I want** resilient distance/ETA calculation with fallback strategies,
**so that** recommendations continue to work even if OpenRouteService is unavailable.

## Acceptance Criteria

1. **Retry Logic:** Retry failed ORS requests with exponential backoff
2. **Circuit Breaker:** Circuit breaker to prevent cascading failures
3. **Timeout Handling:** Handle request timeouts gracefully
4. **Fallback to Haversine:** Fall back to Haversine if ORS unavailable
5. **Degraded Mode:** System continues with reduced accuracy
6. **Error Logging:** Log failures for monitoring
7. **Health Checks:** Monitor ORS API health
8. **Graceful Degradation:** Recommendations work with Haversine-only
9. **Recovery:** Automatic recovery when ORS available again
10. **Documentation:** Resilience strategy documented

## Tasks / Subtasks

- [x] Configure Polly retry policy
  - [x] Set up exponential backoff
  - [x] Configure retry count (2 attempts)
  - [x] Handle specific error types
- [x] Configure circuit breaker
  - [x] Set failure threshold (5 failures)
  - [x] Set circuit open duration (30 seconds)
  - [x] Handle circuit states
- [x] Implement timeout handling
  - [x] Set request timeouts (3500ms)
  - [x] Handle timeout errors
  - [x] Fall back on timeout
- [x] Implement fallback to Haversine
  - [x] Detect ORS unavailability
  - [x] Switch to Haversine calculation
  - [x] Log fallback usage
- [x] Implement degraded mode
  - [x] Continue with Haversine-only
  - [x] Mark recommendations as degraded (via result metadata)
  - [x] Still provide recommendations
- [ ] Add health monitoring
  - [ ] Monitor ORS API health
  - [ ] Track failure rates
  - [ ] Alert on persistent failures
  - Note: Health monitoring deferred to Epic 10 (Observability)
- [x] Implement recovery logic
  - [x] Detect when ORS available again (circuit breaker auto-recovery)
  - [x] Switch back to ORS (automatic via circuit breaker)
  - [x] Log recovery
- [x] Add error logging
  - [x] Log all failures
  - [x] Include context in logs
  - [x] Track failure patterns

## Dev Notes

### Relevant Source Tree Info
- Resilience policies: `src/SmartScheduler.Infrastructure/Resilience/`
- Fallback logic: `src/SmartScheduler.Application/Scheduling/Services/DistanceService.cs`

### Architecture References
- **Resilience:** Polly for retry and circuit breaker - see `docs/prd/a-openrouteservice-ors.md`
- **Fallback:** Haversine fallback - see `docs/prd/caching-performance.md`
- **Degraded Mode:** System continues with reduced accuracy - see PRD

### Testing Standards
- **Test Location:** `src/SmartScheduler.Infrastructure.Tests/`
- **Resilience Tests:** Test retry, circuit breaker, timeouts
- **Fallback Tests:** Test Haversine fallback behavior

### UI Integration Notes
- Fallback transparent to UI
- Recommendations may be marked as "estimated" if using Haversine
- UI continues to work in degraded mode

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `IDistanceCalculationService` interface and `DistanceCalculationService` implementation in `src/SmartScheduler.Application/Contracts/Services/`
- Implemented fallback to Haversine when ORS unavailable
- Returns `DistanceResult` and `EtaResult` with metadata indicating degraded mode
- ETA estimation from Haversine uses average speed (50 km/h) for conversion
- Polly resilience policies configured in `Program.cs`:
  - Retry: 2 attempts with exponential backoff + jitter
  - Circuit breaker: 5 failures trigger 30-second open circuit
  - Timeout: 3500ms per request
- Automatic recovery when circuit breaker resets
- Comprehensive error logging with context
- Service registered in `Program.cs` for dependency injection
- Health monitoring deferred to Epic 10 (Observability)

### File List
- `src/SmartScheduler.Application/Contracts/Services/IDistanceCalculationService.cs` (new)
- `src/SmartScheduler.Application/Contracts/Services/DistanceCalculationService.cs` (new)
- `src/SmartScheduler.Api/Program.cs` (modified - registered distance calculation service with fallback)

## QA Results
_To be populated by QA agent_

