# Story 4.1: OpenRouteService Client Implementation

## Status
Approved

## Story

**As a** system,
**I want** an OpenRouteService client to calculate distances and ETAs,
**so that** I can determine travel time between locations for recommendations.

## Acceptance Criteria

1. **ORS Client:** HTTP client for OpenRouteService API v2
2. **Distance Calculation:** Calculate distance between two points
3. **ETA Calculation:** Calculate estimated travel time
4. **Matrix API:** Support for distance matrix requests
5. **API Key Management:** API key stored in AWS Secrets Manager
6. **Error Handling:** Graceful handling of API failures
7. **Resilience:** Retry logic with Polly
8. **Configuration:** ORS endpoint and settings configurable
9. **Response Parsing:** Parse ORS API responses correctly
10. **Documentation:** ORS integration documented

## Tasks / Subtasks

- [x] Create ORS client interface
  - [x] Create `IOpenRouteServiceClient` interface
  - [x] Define methods for distance/ETA calculation
- [x] Implement HTTP client
  - [x] Create HTTP client for ORS API
  - [x] Configure base URL and endpoints
  - [x] Add API key authentication
- [x] Implement distance calculation
  - [x] Call ORS distance API
  - [x] Parse distance response (meters)
  - [x] Handle errors
- [x] Implement ETA calculation
  - [x] Call ORS directions API
  - [x] Parse duration response (seconds)
  - [x] Convert to minutes
- [x] Implement matrix API support
  - [x] Support batch distance/ETA requests
  - [x] Parse matrix response
  - [x] Handle partial failures
- [x] Add resilience with Polly
  - [x] Configure retry policy
  - [x] Configure circuit breaker
  - [x] Handle timeouts
- [x] Configure API key
  - [x] Retrieve key from configuration/environment variables
  - [x] Inject key in requests
  - [ ] Retrieve key from AWS Secrets Manager (deferred to infrastructure story)
- [x] Add error handling
  - [x] Handle API errors
  - [x] Handle network failures
  - [x] Log errors for monitoring

## Dev Notes

### Relevant Source Tree Info
- ORS client: `src/SmartScheduler.Infrastructure/ExternalServices/OpenRouteServiceClient.cs`
- Interface: `src/SmartScheduler.Application/Scheduling/Services/IOpenRouteServiceClient.cs`

### Architecture References
- **OpenRouteService:** See `docs/prd/a-openrouteservice-ors.md`
- **Maps API:** OpenRouteService v2 - see `docs/architecture/tech-stack.md`
- **Resilience:** Polly for retry logic - see PRD

### Testing Standards
- **Test Location:** `src/SmartScheduler.Infrastructure.Tests/`
- **Client Tests:** Mock ORS API, test distance/ETA calculation
- **Resilience Tests:** Test retry and circuit breaker behavior

### UI Integration Notes
- Distance and ETA displayed in recommendations
- Frontend shows travel time in recommendation cards
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `IOpenRouteServiceClient` interface in `src/SmartScheduler.Application/Contracts/Services/`
- Implemented `OpenRouteServiceClient` in `src/SmartScheduler.Infrastructure/ExternalServices/`
- Implemented distance calculation using ORS directions API
- Implemented ETA calculation using ORS directions API (converts seconds to minutes)
- Implemented matrix API support for batch distance/ETA requests
- Added Polly resilience policies: retry (2 attempts with exponential backoff), circuit breaker (5 failures, 30s open), timeout (3500ms)
- Configured API key retrieval from configuration/environment variables
- AWS Secrets Manager integration deferred to infrastructure story
- Added comprehensive error handling with logging
- All services registered in `Program.cs` with proper dependency injection

### File List
- `src/SmartScheduler.Application/Contracts/Services/IOpenRouteServiceClient.cs` (new)
- `src/SmartScheduler.Infrastructure/ExternalServices/OpenRouteServiceClient.cs` (new)
- `src/SmartScheduler.Infrastructure/SmartScheduler.Infrastructure.csproj` (modified - added Polly packages)
- `src/SmartScheduler.Api/Program.cs` (modified - registered ORS client with Polly policies)
- `src/SmartScheduler.Api/appsettings.json` (modified - added OpenRouteService configuration)

## QA Results
_To be populated by QA agent_

