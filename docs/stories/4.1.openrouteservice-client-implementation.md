# Story 4.1: OpenRouteService Client Implementation

## Status
Approved

## Story

**As a** system,
**I want** an OpenRouteService client to calculate distances and ETAs,
**so that** I can determine travel time between locations for recommendations.

## Acceptance Criteria

1. **ORS Client:** HTTP client for OpenRouteService API v2
2. **Distance Calculation:** Calculate distance between two points
3. **ETA Calculation:** Calculate estimated travel time
4. **Matrix API:** Support for distance matrix requests
5. **API Key Management:** API key stored in AWS Secrets Manager
6. **Error Handling:** Graceful handling of API failures
7. **Resilience:** Retry logic with Polly
8. **Configuration:** ORS endpoint and settings configurable
9. **Response Parsing:** Parse ORS API responses correctly
10. **Documentation:** ORS integration documented

## Tasks / Subtasks

- [ ] Create ORS client interface
  - [ ] Create `IOpenRouteServiceClient` interface
  - [ ] Define methods for distance/ETA calculation
- [ ] Implement HTTP client
  - [ ] Create HTTP client for ORS API
  - [ ] Configure base URL and endpoints
  - [ ] Add API key authentication
- [ ] Implement distance calculation
  - [ ] Call ORS distance API
  - [ ] Parse distance response (meters)
  - [ ] Handle errors
- [ ] Implement ETA calculation
  - [ ] Call ORS directions API
  - [ ] Parse duration response (seconds)
  - [ ] Convert to minutes
- [ ] Implement matrix API support
  - [ ] Support batch distance/ETA requests
  - [ ] Parse matrix response
  - [ ] Handle partial failures
- [ ] Add resilience with Polly
  - [ ] Configure retry policy
  - [ ] Configure circuit breaker
  - [ ] Handle timeouts
- [ ] Configure API key
  - [ ] Retrieve key from AWS Secrets Manager
  - [ ] Inject key in requests
- [ ] Add error handling
  - [ ] Handle API errors
  - [ ] Handle network failures
  - [ ] Log errors for monitoring

## Dev Notes

### Relevant Source Tree Info
- ORS client: `src/SmartScheduler.Infrastructure/ExternalServices/OpenRouteServiceClient.cs`
- Interface: `src/SmartScheduler.Application/Scheduling/Services/IOpenRouteServiceClient.cs`

### Architecture References
- **OpenRouteService:** See `docs/prd/a-openrouteservice-ors.md`
- **Maps API:** OpenRouteService v2 - see `docs/architecture/tech-stack.md`
- **Resilience:** Polly for retry logic - see PRD

### Testing Standards
- **Test Location:** `src/SmartScheduler.Infrastructure.Tests/`
- **Client Tests:** Mock ORS API, test distance/ETA calculation
- **Resilience Tests:** Test retry and circuit breaker behavior

### UI Integration Notes
- Distance and ETA displayed in recommendations
- Frontend shows travel time in recommendation cards
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

