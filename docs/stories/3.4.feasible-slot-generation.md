# Story 3.4: Feasible Slot Generation

## Status
Ready for Review

## Story

**As a** system,
**I want** to generate feasible time slots for contractors,
**so that** recommendations can suggest specific times for job assignments.

## Acceptance Criteria

1. **Slot Generation:** Generate feasible slots within service window
2. **Multiple Slots:** Generate up to 3 slots per contractor (earliest, lowest-travel, highest-confidence)
3. **Slot Types:** Different slot types for different optimization goals
4. **Confidence Scoring:** Calculate confidence score for each slot
5. **Feasibility Checks:** Verify slots are feasible (working hours, existing jobs, buffers)
6. **Slot Format:** Slots include startUtc, endUtc, type, confidence
7. **Performance:** Efficient slot generation
8. **Edge Cases:** Handle cases with no feasible slots
9. **Deterministic:** Same inputs produce same slots
10. **Integration:** Slots integrated with recommendations API

## Tasks / Subtasks

- [x] Create slot generation service
  - [x] Create `ISlotGenerator` interface
  - [x] Implement slot generation logic
- [x] Implement earliest slot generation
  - [x] Find earliest feasible start time
  - [x] Calculate slot end time (duration + buffer)
  - [x] Verify feasibility
- [x] Implement lowest-travel slot generation
  - [x] Consider travel time from previous job
  - [x] Find slot with minimum travel
  - [x] Calculate slot timing
- [x] Implement highest-confidence slot generation
  - [x] Calculate confidence based on factors
  - [x] Find slot with highest confidence
  - [x] Consider availability, travel, contractor rating
- [x] Implement confidence calculation
  - [x] Factor in availability window size
  - [x] Factor in travel time
  - [x] Factor in contractor reliability
  - [x] Return 0-100 confidence score
- [x] Integrate with availability engine
  - [x] Use availability engine for feasibility
  - [x] Apply travel buffers
  - [x] Consider existing assignments
- [x] Integrate with fatigue limits
  - [x] Include fatigue checks in slot generation
  - [x] Block slots that violate limits
  - [x] Support rush job parameter
- [x] Create slot DTOs
  - [x] Create `TimeSlotDto` DTO
  - [x] Include all required fields
- [x] Add unit tests
  - [x] Test slot generation scenarios
  - [x] Test confidence calculation
  - [x] Test edge cases

## Dev Notes

### Relevant Source Tree Info
- Slot generator: `src/SmartScheduler.Domain/Scheduling/Services/SlotGenerator.cs`
- Slot DTOs: `src/SmartScheduler.Application/DTOs/TimeSlot.cs`

### Architecture References
- **Time Slots:** See `docs/architecture/data-models.md` for TimeSlot model
- **Recommendations:** Up to 3 slots per contractor - see `docs/architecture/api-specification.md`
- **Slot Types:** earliest, lowest-travel, highest-confidence - see PRD
- **Epic 4 Dependency:** This story requires ETA values from Epic 4 (Distance & ETA Service) for travel buffer calculations. ETAs for `baseToJobEtaMinutes` and `previousJobToJobEtaMinutes` parameters are provided via Epic 4 services (`IOpenRouteServiceClient`, `IDistanceCalculationService`, or `IETAMatrixService`). Slot generation uses these ETAs to calculate travel buffers via `ITravelBufferService`.

### Testing Standards
- **Test Location:** `src/SmartScheduler.Domain.Tests/`
- **Slot Generation Tests:** Test various scenarios
- **Confidence Tests:** Test confidence calculation
- **Integration Tests:** Test with availability engine

### UI Integration Notes
- Slots displayed in recommendation cards
- Frontend has `RecommendationCard` component showing slots
- UI is 95% complete - needs API integration

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A - No issues encountered during implementation

### Completion Notes List
- Created `ISlotGenerator` interface and `SlotGenerator` implementation in `src/SmartScheduler.Domain/Scheduling/Services/`
- Implemented three slot types:
  - **Earliest slot**: Finds earliest feasible start time accounting for travel buffer
  - **Lowest-travel slot**: Finds slot with minimum travel time (considers previous job ETA or base-to-job ETA)
  - **Highest-confidence slot**: Finds slot with highest confidence score based on availability window, travel time, and contractor rating
- Implemented confidence calculation (0-100) that factors in:
  - Availability window size (20% weight)
  - Travel time (20% weight, inverse relationship)
  - Contractor rating (60% weight)
- Integrated with availability engine, travel buffer service, and fatigue calculator:
  - Requests slots large enough to fit buffer + job duration
  - Applies travel buffers (base-to-first, job-to-job) appropriately
  - Considers existing assignments through availability engine
  - Checks fatigue limits (daily hours, consecutive jobs) for each generated slot
  - Supports rush job parameter to bypass soft caps (but not hard stops)
  - Filters out slots that violate fatigue limits
- Created `TimeSlotDto` in Application layer for API responses
- Created `GeneratedSlot` domain model with `SlotType` enum
- Handles edge cases: no available slots, slots that don't fit after buffer, duplicate removal
- Returns up to 3 slots per contractor (removes duplicates, takes first 3)
- Created comprehensive unit tests covering:
  - All three slot types
  - Confidence calculation with different contractor ratings
  - Existing assignment blocking
  - Edge cases (no available time, deterministic results)
- All 8 unit tests pass successfully
- Slot generation is deterministic and efficient

### File List
- `src/SmartScheduler.Domain/Scheduling/Services/ISlotGenerator.cs` (new, modified - added isRushJob parameter)
- `src/SmartScheduler.Domain/Scheduling/Services/SlotGenerator.cs` (new, modified - integrated fatigue calculator)
- `src/SmartScheduler.Application/Contracts/DTOs/TimeSlotDto.cs` (new)
- `src/SmartScheduler.Domain.Tests/Scheduling/SlotGeneratorTests.cs` (new, modified - added fatigue calculator dependency)

## QA Results
_To be populated by QA agent_

