# Story 2.5: Timezone Lookup Integration

## Status
Approved

## Story

**As a** system,
**I want** to automatically determine timezone from job location coordinates,
**so that** time calculations are accurate for different geographic regions.

## Acceptance Criteria

1. **Timezone Service:** Timezone lookup service implemented
2. **Coordinate Lookup:** IANA timezone derived from latitude/longitude
3. **Timezone Storage:** Timezone stored on Job entity
4. **Caching:** Timezone lookups cached (timezone doesn't change)
5. **Default Fallback:** Default to contractor timezone if lookup fails
6. **Error Handling:** Graceful handling of timezone lookup failures
7. **API Integration:** Timezone API or library integrated
8. **Job Creation:** Timezone automatically set during job creation
9. **Timezone Usage:** Timezone used for service window calculations
10. **Documentation:** Timezone lookup process documented

## Tasks / Subtasks

- [ ] Choose timezone lookup solution
  - [ ] Evaluate timezone APIs/libraries
  - [ ] Select appropriate solution (e.g., TimeZoneMapper, Google Time Zone API)
- [ ] Create timezone service
  - [ ] Create `ITimezoneService` interface
  - [ ] Implement timezone lookup from coordinates
  - [ ] Return IANA timezone identifier
- [ ] Implement caching
  - [ ] Cache timezone lookups by lat/long (rounded)
  - [ ] Use in-memory cache
  - [ ] Timezone doesn't change, so long TTL
- [ ] Integrate with job creation
  - [ ] Call timezone lookup in CreateJobCommand
  - [ ] Store timezone on job entity
  - [ ] Handle lookup failures (use default)
- [ ] Add error handling
  - [ ] Handle API failures
  - [ ] Fall back to contractor timezone or default
  - [ ] Log errors for monitoring
- [ ] Update job entity
  - [ ] Add timezone property
  - [ ] Configure EF Core mapping
  - [ ] Create database migration
- [ ] Use timezone in calculations
  - [ ] Use timezone for service window calculations
  - [ ] Use timezone for availability matching

## Dev Notes

### Relevant Source Tree Info
- Timezone service: `src/SmartScheduler.Infrastructure/Services/TimezoneService.cs`
- Job entity: `src/SmartScheduler.Domain/Jobs/Entities/Job.cs`

### Architecture References
- **Timezone Lookup:** See `docs/architecture/api-specification.md` section "Timezone Lookup"
- **Data Models:** See `docs/architecture/data-models.md` for Job timezone field
- **Job Creation:** Timezone set during job creation - see Epic 2

### Testing Standards
- **Test Location:** `src/SmartScheduler.Infrastructure.Tests/`
- **Service Tests:** Test timezone lookup for various coordinates
- **Integration Tests:** Test timezone lookup in job creation flow

### UI Integration Notes
- Frontend doesn't need to handle timezone directly
- Backend automatically determines timezone from address
- Timezone used for backend calculations only

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

