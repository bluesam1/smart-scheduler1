# Story 6.3: Audit Trail Persistence

## Status
Approved

## Story

**As a** system,
**I want** to persist full audit trail for recommendation requests,
**so that** I can track recommendation decisions and improve the algorithm.

## Acceptance Criteria

1. **Audit Entity:** AuditRecommendation entity created
2. **Request Persistence:** Original request payload persisted
3. **Candidates Persistence:** All qualified contractors with scores persisted
4. **Selection Tracking:** Selected contractor tracked (if assignment created)
5. **Config Version:** Scoring config version included
6. **Actor Tracking:** Selection actor tracked (system or dispatcher)
7. **Retention:** Audit records retained for 12 months (configurable)
8. **Query Support:** Audit records queryable by jobId, date range
9. **Performance:** Audit writes don't impact recommendation performance
10. **Data Integrity:** Audit data complete and accurate

## Tasks / Subtasks

- [ ] Create AuditRecommendation entity
  - [ ] Create entity in domain
  - [ ] Include all required fields
  - [ ] Configure EF Core mapping
- [ ] Implement audit persistence
  - [ ] Create audit record in recommendations flow
  - [ ] Persist request payload
  - [ ] Persist candidate scores
  - [ ] Link to assignment if created
- [ ] Add config version tracking
  - [ ] Include config version in audit
  - [ ] Link to WeightsConfig
- [ ] Add actor tracking
  - [ ] Track selection actor (system/dispatcher)
  - [ ] Include user ID if dispatcher
- [ ] Create database migration
  - [ ] Create AuditRecommendation table
  - [ ] Add indexes for queries
  - [ ] Configure retention policy
- [ ] Implement audit queries
  - [ ] Query by jobId
  - [ ] Query by date range
  - [ ] Query by contractor
- [ ] Optimize performance
  - [ ] Async audit writes
  - [ ] Don't block recommendation response
  - [ ] Batch writes if needed
- [ ] Add retention policy
  - [ ] Implement 12-month retention
  - [ ] Create cleanup job (future)
- [ ] Create unit tests
  - [ ] Test audit persistence
  - [ ] Test data completeness
  - [ ] Test query functionality

## Dev Notes

### Relevant Source Tree Info
- Audit entity: `src/SmartScheduler.Domain/Recommendations/Entities/AuditRecommendation.cs`
- Audit repository: `src/SmartScheduler.Infrastructure/Repositories/AuditRecommendationRepository.cs`
- Audit service: `src/SmartScheduler.Application/Recommendations/Services/AuditService.cs`

### Architecture References
- **Audit Trail:** See `docs/architecture/data-models.md` for AuditRecommendation model
- **Retention:** 12-month retention - see `docs/prd/7-non-functional-requirements.md`
- **Auditability:** See PRD section on auditability requirements

### Testing Standards
- **Test Location:** `src/SmartScheduler.Application.Tests/` and `src/SmartScheduler.Infrastructure.Tests/`
- **Audit Tests:** Test persistence, data completeness, queries
- **Performance Tests:** Verify audit doesn't impact recommendation performance

### UI Integration Notes
- Audit trail not directly displayed in UI
- May be used for admin reporting (future)
- Audit data supports algorithm improvement

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

