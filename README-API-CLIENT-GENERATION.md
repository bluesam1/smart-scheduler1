# API Client Generation

This document explains how to generate the TypeScript API client from the backend OpenAPI specification.

## Overview

We use **NSwag** to generate a TypeScript client from the OpenAPI specification. The generation process:
1. Builds the API
2. Starts the API server
3. Fetches the OpenAPI spec from the running API
4. Generates the TypeScript client from the spec
5. Stops the server

## Quick Start

**Linux/Mac (Bash):**
```bash
./scripts/generate-api-client.sh
```

This single script handles all steps automatically.

## How It Works

The `generate-api-client.sh` script:
1. **Builds the API** - Compiles the .NET project
2. **Starts the API server** - Runs the API in the background on `http://localhost:5004`
3. **Waits for API readiness** - Polls the `/health` endpoint until the API is ready
4. **Fetches OpenAPI spec** - Downloads the spec from `/swagger/v1/swagger.json`
5. **Generates TypeScript client** - Uses `nswag openapi2tsclient` to generate the client
6. **Stops the server** - Automatically cleans up the background process

## Prerequisites

- .NET 8 SDK installed
- NSwag CLI tool installed globally:
  ```bash
  dotnet tool install -g NSwag.ConsoleCore
  ```
- `curl` command available (for health check and fetching OpenAPI spec)

## Generated Files

The generated client will be at:
```
frontend/lib/api/generated/api-client.ts
```

**⚠️ DO NOT EDIT THIS FILE MANUALLY** - It will be overwritten on regeneration.

## When to Regenerate

Regenerate the API client when:
- Backend API endpoints are added, modified, or removed
- Request/response DTOs change
- Before starting frontend development on a new feature

## Integration

After generation, use the generated client classes in your frontend code:

```typescript
import { ContractorsClient, JobsClient, RecommendationsClient } from './generated/api-client';

export function createApiClients(accessToken: string | null) {
  const config = createApiClientConfig(accessToken);
  
  return {
    contractors: new ContractorsClient(config.baseUrl, { headers: config.headers }),
    jobs: new JobsClient(config.baseUrl, { headers: config.headers }),
    recommendations: new RecommendationsClient(config.baseUrl, { headers: config.headers }),
  };
}
```

## Troubleshooting

### "API failed to start"
- Check if port 5004 is already in use
- Verify the API project builds successfully
- Check API logs at `/tmp/smartscheduler-api.log`

### "Could not fetch OpenAPI spec"
- Ensure the API is running on `http://localhost:5004`
- Verify the Swagger endpoint is accessible: `http://localhost:5004/swagger/v1/swagger.json`
- Check that `ASPNETCORE_ENVIRONMENT=Development` (Swagger is only enabled in Development)

### "nswag: command not found"
- Install NSwag CLI: `dotnet tool install -g NSwag.ConsoleCore`
- Ensure the .NET tools directory is in your PATH

### Port 5004 already in use
- Stop any existing API instances
- Or modify the port in `src/SmartScheduler.Api/Properties/launchSettings.json` and update the script
